/*!
 * SharepointPlus v5.1
 * Copyright 2018, Aymeric (@aymkdn)
 * Contact: http://kodono.info
 * Documentation: http://aymkdn.github.com/SharepointPlus/
 * License: LGPL-3 (http://aymkdn.github.com/SharepointPlus/license.md)
 */
var SPArrayChunk=function(e,t){for(var r=[],n=0,i=e.length;n<i;n+=t)r.push(e.slice(n,n+t));return r},SPExtend=function(){var e,t,r,n,i=arguments[0]||{},o=1,a=arguments.length,s=!1,l=function(e){if(null===e||"object"!=typeof e||e.nodeType||null!==e&&e===e.window)return!1;try{if(e.constructor&&!this.hasOwnProperty.call(e.constructor.prototype,"isPrototypeOf"))return!1}catch(e){return!1}return!0};for("boolean"==typeof i&&(s=i,i=arguments[o]||{},o++),"object"!=typeof i&&"function"!=typeof i&&(i={});o<a;o+=1)if(null!==(e=arguments[o]))for(t in e)i!==e[t]&&void 0===i[t]&&(s&&e[t]&&(l(e[t])||(r=Array.isArray(e[t])))?(n=r?(r=!1,i[t]&&Array.isArray(i[t])?i[t]:[]):i[t]&&l(i[t])?i[t]:{},i[t]=SPExtend(s,n,e[t])):void 0!==e[t]&&(i[t]=e[t]));return i},SPArrayBufferToBase64=function(e){for(var t,r="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=new Uint8Array(e),o=i.byteLength,a=o%3,s=o-a,l=0;l<s;l+=3)r+=n[(16515072&(t=i[l]<<16|i[l+1]<<8|i[l+2]))>>18]+n[(258048&t)>>12]+n[(4032&t)>>6]+n[63&t];return 1==a?r+=n[(252&(t=i[s]))>>2]+n[(3&t)<<4]+"==":2==a&&(r+=n[(64512&(t=i[s]<<8|i[s+1]))>>10]+n[(1008&t)>>4]+n[(15&t)<<2]+"="),r},_SP_CACHE_CONTENTTYPES=[],_SP_CACHE_CONTENTTYPE=[],_SP_CACHE_SAVEDVIEW=[],_SP_CACHE_SAVEDVIEWS=[],_SP_CACHE_SAVEDLISTS=[],_SP_CACHE_USERGROUPS=[],_SP_CACHE_GROUPMEMBERS=[],_SP_CACHE_DISTRIBUTIONLISTS=[],_SP_CACHE_REGIONALSETTINGS=void 0,_SP_CACHE_DATEFORMAT=void 0,_SP_CACHE_HASREST={},_SP_CACHE_REQUESTDIGEST={},_SP_CACHE_TIMEZONEINFO={},_SP_ADD_PROGRESSVAR={},_SP_UPDATE_PROGRESSVAR={},_SP_MODERATE_PROGRESSVAR={},_SP_REMOVE_PROGRESSVAR={},_SP_BASEURL=void 0,_SP_NOTIFY_READY=!1,_SP_NOTIFY_QUEUE=[],_SP_NOTIFY=[],_SP_PLUGINS={},_SP_MODALDIALOG_LOADED=!1,_SP_MAXWHERE_ONLOOKUP=30,_SP_ISBROWSER=new Function("try {return this===window;}catch(e){ return false;}")(),_SP_JSON_ACCEPT="verbose";!function(h,c,R){function e(){if(!(this instanceof e))return new e}e.prototype={data:[],length:0,listQueue:[],needQueue:!1,module_sprequest:null,credentialOptions:null,proxyweb:null,getVersion:function(){return"5.2"},_promise:function(e){return new Promise(e)},hasREST:function(i){var o=this;return o._promise(function(e){var t=((i=i||{}).url||o.url||h.location.href).split("/").slice(0,3).join("/");if("boolean"!=typeof _SP_CACHE_HASREST[t]){var r,n=!(!i.url&&_SP_ISBROWSER&&"undefined"!=typeof SP);if(!n){if("undefined"!=typeof SP&&SP.ClientSchemaVersions)return r=14<parseInt(SP.ClientSchemaVersions.currentVersion),_SP_CACHE_HASREST[t]=r,void e(r);n=!0}n?o.ajax({url:t+"/_api/web/Url"}).then(function(){_SP_CACHE_HASREST[t]=!0,e(!0)},function(){_SP_CACHE_HASREST[t]=!1,e(!1)}):(_SP_CACHE_HASREST[t]=!1,e(!1))}else e(_SP_CACHE_HASREST[t])})},getRequestDigest:function(e){var a=this;return a._promise(function(t,r){(e=e||{}).cache=!1!==e.cache;var n,i,o=e.url||a.url;if(o||(o=h.location.href.split("/").slice(0,3).join("/")),-1!==(o=o.toLowerCase()).indexOf("_api")?o=o.split("_api")[0]:-1!==o.indexOf("_vti_bin/client.svc/processquery")&&(o=o.split("_vti_bin/client.svc/processquery")[0]),e.cache&&(i=_SP_CACHE_REQUESTDIGEST[o]),!(i&&(new Date).getTime()-new Date(i.split(",")[1]).getTime()<864e5))return _SP_ISBROWSER&&c&&e.cache&&(n=c.querySelector("#__REQUESTDIGEST"))?(i=n.value,_SP_CACHE_REQUESTDIGEST[o]=i,void t(i)):void a.ajax({url:o+"/_api/contextinfo",method:"POST"}).then(function(e){i=e.d.GetContextWebInformation.FormDigestValue,_SP_CACHE_REQUESTDIGEST[o]=i,c&&(n=c.querySelector("#__REQUESTDIGEST"))&&(n.value=i),t(i)},function(e){r(e)});t(i)})},ajax:function(a){var e,g,m,s=this;return a.headers=a.headers||{},g=h,m=["responseType","withCredentials","timeout"],(e={}).ajax=function(e,r){function t(e,t){return function(){a||(r(void 0===s.status?e:s.status,0===s.status?"Error":s.response||s.responseText||t,s),a=!0)}}var n=e.headers||{},i=e.body,o=e.method||(i?"POST":"GET"),a=!1,s=e.cors&&g.XDomainRequest&&!/MSIE 1/.test(navigator.userAgent)?new XDomainRequest:g.XMLHttpRequest?new XMLHttpRequest:void 0;s.open(o,e.url,!0);var l,u,c,d=s.onload=t(200);s.onreadystatechange=function(){4===s.readyState&&d()},s.onerror=t(null,"Error"),s.ontimeout=t(null,"Timeout"),s.onabort=t(null,"Abort"),i&&(g.FormData&&i instanceof g.FormData||(c="application/x-www-form-urlencoded",(l=n)[u="Content-Type"]=l[u]||c));for(var f=0,h=m.length;f<h;f++)void 0!==e[p=m[f]]&&(s[p]=e[p]);for(var p in n)!1!==n[p]&&s.setRequestHeader(p,n[p]);return e.onprogress&&("GET"===o.toUpperCase()?s.addEventListener("progress",e.onprogress,!1):s.upload.addEventListener("progress",e.onprogress,!1)),e.getXHR&&e.getXHR(s),s.send(i),s},g.nanoajax=e,s._promise(function(i,o){var e=!1;if(-1<a.url.toLowerCase().indexOf("/_api/")&&-1===a.url.toLowerCase().indexOf("_api/web/url")&&(void 0===a.headers.Accept&&(a.headers.Accept="application/json;odata="+_SP_JSON_ACCEPT),void 0===a.headers["Content-Type"]&&(a.headers["Content-Type"]="application/json;odata="+_SP_JSON_ACCEPT),void 0===a.headers["X-RequestDigest"]&&-1===a.url.indexOf("contextinfo")&&(e=!0)),-1<a.url.toLowerCase().indexOf("_vti_bin/client.svc/processquery")&&void 0===a.headers["X-RequestDigest"]&&(e=!0),e)s.getRequestDigest({url:a.url.toLowerCase().split("_api")[0]}).then(function(e){return a.headers["X-RequestDigest"]=e,s.ajax(a)}).then(function(e){i(e)}).catch(function(e){o(e)});else if(void 0===a.headers["Content-Type"]&&(a.headers["Content-Type"]="text/xml; charset=utf-8"),_SP_ISBROWSER)"POST"!==a.method||a.body||(a.body=""),nanoajax.ajax(a,function(e,t,r){if(200<=e&&e<300&&"Error"!==t&&"Abort"!==t&&"Timeout"!==t){var n=r.responseType&&"document"!==r.responseType?t:r.responseXML||r.responseText;-1<r.getResponseHeader("Content-Type").indexOf("/json")&&"string"==typeof n&&(n=JSON.parse(n)),i(n)}else 403==e&&-1<t.indexOf("The security validation for this page is invalid and might be corrupted. Please use your web browser's Back button to try your operation again.")?(delete a.headers["X-RequestDigest"],s.getRequestDigest({cache:!1}).then(function(e){return a.headers["X-RequestDigest"]=e,s.ajax(a)}).then(function(e){i(e)}).catch(function(e){o(e)})):o({statusCode:e,responseText:t,request:r})});else{if(null===s.module_sprequest){if(null===s.credentialOptions)throw"[SharepointPlus 'ajax'] please use `$SP().auth()` to provide your credentials first";s.module_sprequest=require("sp-request").create(s.credentialOptions)}a.headers["Content-Type"]&&-1<a.headers["Content-Type"].indexOf("xml")&&(a.headers.Accept="application/xml, text/xml, */*; q=0.01"),a.method||(a.method=void 0!==a.body?"POST":"GET"),"POST"===a.method.toUpperCase()&&void 0!==a.body&&(a.headers["Content-Length"]=Buffer.byteLength(a.body));var t={json:!(a.headers["User-Agent"]="Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:52.0) Gecko/20100101 Firefox/52.0"),method:a.method,strictSSL:!1,headers:a.headers,jar:!0};for(var r in a.body&&(t.body=a.body),s.proxyweb&&(t.proxy=s.proxyweb),t.headers&&delete t.headers["Content-Length"],a)a.hasOwnProperty(r)&&!t[r]&&(t[r]=a[r]);s.module_sprequest(a.url,t).then(function(e){if(200===e.statusCode&&"Error"!==e.statusMessage&&"Abort"!==e.statusMessage&&"Timeout"!==e.statusMessage)if(-1<e.headers["content-type"].indexOf("xml")&&"<?xml"===e.body.slice(0,5)){var t=(new(require("xmldom").DOMParser)).parseFromString(e.body);i(t)}else-1<e.headers["content-type"].indexOf("json")&&"string"==typeof e.body&&(e.body=JSON.parse(e.body)),i(e.body);else o({response:e,statusCode:e.statusCode,responseText:e.body})}).catch(function(e){o({error:e,statusCode:e.statusCode,response:e.response,responseText:e.response?e.response.body:""})})}})},auth:function(e){return this.credentialOptions=e,this},proxy:function(e){return this.proxyweb=e,this},list:function(e,t){var r=this.reset();return t?r.url="/"===t.slice(-1)?t.slice(0,-1):t:r._getURL(),r.listID=e.replace(/&/g,"&amp;"),r},_getURL:function(o){var a=this;return o=!1!==o,a._promise(function(n,i){if(void 0===a.url)if(void 0!==_SP_BASEURL)o&&(a.url=_SP_BASEURL),""!==a.url&&"/"!==a.url||(a.url=h.location.protocol+"//"+h.location.host+"/"),n(_SP_BASEURL);else if(void 0!==h.L_Menu_BaseUrl)o&&(a.url=_SP_BASEURL=h.L_Menu_BaseUrl),""!==a.url&&"/"!==a.url||(a.url=h.location.protocol+"//"+h.location.host+"/"),n(h.L_Menu_BaseUrl);else{if(void 0===h._spPageContextInfo||void 0===h._spPageContextInfo.webServerRelativeUrl)return a.needQueue=!0,void a.ajax({url:"/_vti_bin/Webs.asmx",body:a._buildBodyForSOAP("WebUrlFromPageUrl","<pageUrl>"+h.location.href.replace(/&/g,"&amp;")+"</pageUrl>")}).then(function(e){var t=e.getElementsByTagName("WebUrlFromPageUrlResult");if(t.length){var r=t[0].firstChild.nodeValue.toLowerCase();o&&(a.url=_SP_BASEURL=r),n(r)}else i("[SharepointPlus '_getURL'] Unable to retrieve the URL");a.needQueue=!1},function(e){i(e)});o&&(a.url=_SP_BASEURL=h._spPageContextInfo.webServerRelativeUrl),""!==a.url&&"/"!==a.url||(a.url=h.location.protocol+"//"+h.location.host+"/"),n(h._spPageContextInfo.webServerRelativeUrl)}i("[SharepointPlus '_getURL'] Unable to retrieve the URL")})},getURL:function(){return this._getURL(!1)},_buildBodyForSOAP:function(e,t,r){return'<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"><soap:Body><'+e+' xmlns="'+(r=r||"http://schemas.microsoft.com/sharepoint/soap/")+'">'+t+"</"+e+"></soap:Body></soap:Envelope>"},webService:function(o){var a=this;return a._promise(function(t,r){var e,n,i="";if(!o.service)throw"Error 'webService': the option 'service' is required";if(!o.operation)throw"Error 'webService': the option 'operation' is required";if(o.webURL=o.webURL||a.url,o.webURL){for(e in o.properties=o.properties||{},o.properties)o.properties.hasOwnProperty(e)&&(i+="<"+e+">"+o.properties[e]+"</"+e+">");o.soapAction=!1!==o.soapAction,o.soapURL=o.soapURL||"http://schemas.microsoft.com/sharepoint/soap/",o.soapAction||(o.soapURL=o.soapURL.replace(/\/$/,"")),i=a._buildBodyForSOAP(o.operation,i,o.soapURL),n={url:o.webURL+"/_vti_bin/"+o.service+".asmx",body:i},o.soapAction&&(n.headers={SOAPAction:o.soapURL+o.operation}),a.ajax(n).then(function(e){t(e)},function(e){r(e)})}else a._getURL().then(function(e){o.webURL=e,a.webService(o).then(function(e){t(e)},function(e){r(e)})},function(e){r(e)})})},_addInQueue:function(){return this.listQueue.push(arguments),1===this.listQueue.length&&this._testQueue(),this},_testQueue:function(){var e=this;if(e.needQueue)setTimeout(function(){e._testQueue.call(e)},25);else{if(0<e.listQueue.length){var t=e.listQueue.shift();e[t[0]].apply(e,t[1])}e.needQueue=0<e.listQueue.length,e.needQueue&&setTimeout(function(){e._testQueue.call(e)},25)}},parse:function(e,t){var r=e.replace(/(\s+)?(=|~=|<=|>=|<>|<|>| LIKE | IN )(\s+)?/g,"$2").replace(/""|''/g,"Null").replace(/==/g,"=");/\w+ IN \[([^[]+,)?Null,?/.test(r)&&(r=r.replace(/(\w+) IN \[([^\[]+,)?Null(,[^\]]+)?\]/g,"($1 = Null OR $&)").replace(/\[([^\[]+,)?Null(,[^\]]+)?\]/g,"[$1$2]").replace(/(\[),|(,),|,(\])/g,"$1$2$3"));var n=[];t=!1!==t;for(var i=r.length,o="",a="",s=!1,l="",u={open:0},c=!1,d=0;d<r.length;d++){var f=r.charAt(d);switch(f){case"(":for(var h=d,p=!1;"("==r.charAt(d)&&d<i;)d++,u.open++;for(;0<u.open&&d<i;){d++,"\\"==(g=r.charAt(d))?s=!0:s||"'"!=g&&'"'!=g?s||")"!=g||p?s=!1:u.open--:p=!p}0<=(m=n.length-1)?(""!=o&&(n[0]="<"+o+">"+n[0]),n[0]+=this.parse(r.substring(h+1,d)),""!=o&&(n[0]+="</"+o+">"),o=""):n[0]=this.parse(r.substring(h+1,d));break;case"[":for(h=d,p=!1;d<i;){var g;if(d++,"\\"==(g=r.charAt(d)))s=!0;else if(s||"'"!=g&&'"'!=g){if(!s&&!p&&"]"==g)break;s=!1}else p=!p}var m=n.length-1,S=JSON.parse("["+r.substring(h+1,d)+"]"),y="Text";switch(typeof S[0]){case"number":y="Number";break;default:"~"===S[0].charAt(0)&&"number"==typeof(1*S[0].slice(1))&&(y="Integer",S.forEach(function(e,t){S[t]=e.slice(1)}))}n[m]+='<FieldRef Name="'+l+'" '+("Integer"===y?'LookupId="True"':"")+' /><Values><Value Type="'+y+'">'+S.join('</Value><Value Type="'+y+'">')+"</Value></Values>"+a,a=l="",0<m&&(""!=o&&(n[0]="<"+o+">"+n[0]),n[0]+=n[m],""!=o&&(n[0]+="</"+o+">"),delete n[m],o="");break;case">":case"<":d++,a="="==r.charAt(d)?(n.push("<"+(">"==f?"G":"L")+"eq>"),"</"+(">"==f?"G":"L")+"eq>"):"<"==f&&">"==r.charAt(d)?(n.push("<Neq>"),"</Neq>"):(d--,n.push("<"+(">"==f?"G":"L")+"t>"),"</"+(">"==f?"G":"L")+"t>");break;case"~":"="==r.charAt(d+1)&&(c=!0);break;case"=":n.push("<Eq>"),a="</Eq>";break;case" ":" AND "==r.substring(d,d+5).toUpperCase()?(o="And",d+=4):" OR "==r.substring(d,d+4).toUpperCase()?(o="Or",d+=3):" LIKE "==r.slice(d,d+6).toUpperCase()?(d+=5,n.push("<Contains>"),a="</Contains>"):" IN "==r.slice(d,d+4).toUpperCase()?(d+=3,n.push("<In>"),a="</In>"):l+=f;break;case'"':case"'":for(var _=f,w="",A="";(f=r.charAt(++d))!=_&&d<i;)"\\"==f&&(f=r.charAt(++d)),w+=f;n[m=n.length-1]+='<FieldRef Name="'+l+'" '+("[Me]"==w?'LookupId="True" ':"")+"/>",l="";var v="Text";/\d{4}-\d\d?-\d\d?((T| )\d{2}:\d{2}:\d{2})?/.test(w)&&(v="DateTime",/\d{4}-\d\d?-\d\d?((T| )\d{2}:\d{2}:\d{2})/.test(w)&&(A=' IncludeTimeValue="TRUE"')),t&&(w=this._cleanString(w)),"[Me]"===w?(w='<UserID Type="Integer" />',v="Integer"):"[Today"==w.slice(0,6)&&(v="DateTime",w='<Today OffsetDays="'+1*w.slice(6,-1)+'" />'),n[m]+='<Value Type="'+v+'"'+A+">"+w+"</Value>",n[m]+=a,a="",0<m&&(""!=o&&(n[0]="<"+o+">"+n[0]),n[0]+=n[m],""!=o&&(n[0]+="</"+o+">"),delete n[m],o="");break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":if(""!=a){for(var D=f;!isNaN(f=r.charAt(++d))&&d<i;)D+=""+f;n[m=n.length-1]+='<FieldRef Name="'+l+'"'+(c?' LookupId="True"':"")+" />",l="",n[m]+='<Value Type="'+(c?"Integer":"Number")+'">'+D.replace(/ $/,"")+"</Value>",n[m]+=a,a="",0<m&&(""!=o&&(n[0]="<"+o+">"+n[0]),n[0]+=n[m],""!=o&&(n[0]+="</"+o+">"),delete n[m],o=""),d-=2;break}default:""==a?l+=f:"n"==f.toLowerCase()&&"null"==r.substring(d,d+4).toLowerCase()?(m=n.length-1,"</Neq>"==a?(n[m]="<IsNotNull>",a="</IsNotNull>"):"</Eq>"==a&&(n[m]="<IsNull>",a="</IsNull>"),d+=3,n[m]+='<FieldRef Name="'+l+'" />',l="",n[m]+=a,a="",0<m&&(""!=o&&(n[0]="<"+o+">"+n[0]),n[0]+=n[m],""!=o&&(n[0]+="</"+o+">"),delete n[m],o="")):("t"===f.toLowerCase()&&"true"===r.substring(d,d+4).toLowerCase()||"f"===f.toLowerCase()&&"false"===r.substring(d,d+5).toLowerCase())&&(m=n.length-1,d+=3,"f"===f.toLowerCase()&&d++,n[m]+='<FieldRef Name="'+l+'" /><Value Type="Boolean">'+("t"===f.toLowerCase()?1:0)+"</Value>",l="",n[m]+=a,a="",0<m&&(""!=o&&(n[0]="<"+o+">"+n[0]),n[0]+=n[m],""!=o&&(n[0]+="</"+o+">"),delete n[m],o=""))}}return n.join("")},_parseOn:function(e){for(var t,r=[],n=0,i=e.replace(/(\s+)?(=)(\s+)?/g,"$2").replace(/==/g,"=").split(" AND ");n<i.length;n++)if((t=i[n].match(/'([^']+)'\.([a-zA-Z0-9_]+)='([^']+)'\.([a-zA-Z0-9_]+)/))&&5==t.length){var o={};o[t[1]]=t[2],o[t[3]]=t[4],r.push(o)}return r},parseRecurrence:function(r){var a=["monday","tuesday","wednesday","thursday","friday","saturday","sunday"],s=null;if("string"==typeof r&&"<"===r.charAt(0)){s={};var l=(new DOMParser).parseFromString(r,"text/xml"),t=new XMLSerializer,u=function(e){return e.innerHTML?e.innerHTML:t.serializeToString(e).replace(/^<[^>]+>([^<]+)<\/[^>]+>$/m,"$1")};return["firstDayOfWeek","daily","weekly","monthly","monthlyByDay","yearly","yearlyByDay","windowEnd","repeatInstances"].forEach(function(e){var t=l.getElementsByTagName(e);if(1===t.length){var r=t[0];switch(/y$/.test(e)&&(s.type=e),e){case"firstDayOfWeek":for(var n=u(r),i=0;i<a.length;i++)if(a[i].slice(0,2)===n){s.firstDayOfWeek=a[i];break}break;case"daily":"TRUE"===r.getAttribute("weekday")?s.on={weekday:!0}:s.frequency=1*r.getAttribute("dayFrequency");break;case"weekly":s.frequency=1*r.getAttribute("weekFrequency"),s.on={},a.forEach(function(e){"TRUE"===r.getAttribute(e.slice(0,2))&&(s.on[e]=!0)});break;case"monthly":s.frequency=1*r.getAttribute("monthFrequency"),s.on={day:1*r.getAttribute("day")};break;case"yearlyByDay":case"monthlyByDay":var o=r.getAttribute("weekdayOfMonth")||r.getAttribute("weekDayOfMonth");s.on={},a.forEach(function(e){"TRUE"===r.getAttribute(e.slice(0,2))&&(s.on[e]=o)}),"TRUE"===r.getAttribute("day")&&(s.on.day=o),"TRUE"===r.getAttribute("weekday")&&(s.on.weekday=o),"TRUE"===r.getAttribute("weekend_day")&&(s.on.weekend=o),"monthlyByDay"===e?s.frequency=1*r.getAttribute("monthFrequency"):(s.frequency=1*r.getAttribute("yearFrequency"),s.on.month=1*r.getAttribute("month"));break;case"yearly":s.frequency=1*r.getAttribute("yearFrequency"),s.on={month:1*r.getAttribute("month"),day:1*r.getAttribute("day")};break;case"windowEnd":s.endDate=new Date(u(r));break;case"repeatInstances":s.endAfter=1*u(r)}}}),s}if(r&&"object"==typeof r&&r.type){switch(r.firstDayOfWeek=r.firstDayOfWeek||"mo",s="<recurrence><rule><firstDayOfWeek>"+(r.firstDayOfWeek.toLowerCase().slice(0,2)||"mo")+"</firstDayOfWeek><repeat><"+r.type+" ",r.type){case"daily":s+=(r.frequency?'dayFrequency="'+r.frequency+'"':'weekday="TRUE"')+" />";break;case"weekly":a.forEach(function(e){r.on[e]&&(s+=e.slice(0,2)+'="TRUE" ')}),s+='weekFrequency="'+r.frequency+'" />';break;case"monthly":s+='monthFrequency="'+r.frequency+'" day="'+r.on.day+'" />';break;case"yearlyByDay":case"monthlyByDay":["day","weekday","weekend"].concat(a).forEach(function(e,t){r.on[e]&&(s+=t<3?e+("weekend"===e?"_day":""):e.slice(0,2),-1===(s+='="TRUE" ').indexOf("ayOfMonth")&&(s+="week"+("monthlyByDay"===r.type?"d":"D")+'ayOfMonth="'+r.on[e]+'" '),e=r.on[e])}),r.on.month&&(s+=' month="'+r.on.month+'"'),s+=("monthlyByDay"===r.type?"month":"year")+'Frequency="'+r.frequency+'" />';break;case"yearly":s+='yearFrequency="'+r.frequency+'" month="'+r.on.month+'" day="'+r.on.day+'" />'}return s+="</repeat>",r.endDate?s+="<windowEnd>"+new Date(r.endDate).toISOString().replace(/.000Z/,"Z")+"</windowEnd>":r.endAfter?s+="<repeatInstances>"+r.endAfter+"</repeatInstances>":s+="<repeatForever>FALSE</repeatForever>",s+="</rule></recurrence>"}return null},_cleanString:function(e){return e.replace(/&(?!amp;|lt;|gt;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},cleanResult:function(e,t){return null==e?"":(t=t||";","string"==typeof e?e.replace(/^(string;|float;|datetime;)#?/,"").replace(/;#-?[0-9]+;#/g,t).replace(/^-?[0-9]+;#/,"").replace(/^;#|;#$/g,"").replace(/;#/g,t):e)},get:function(h){var N=this;return N._promise(function(b,T){if(N.needQueue)return N._addInQueue("get",arguments);if(!N.listID)return T("[SharepointPlus 'get']: the list ID/Name is required");var C={};if(SPExtend(!0,C,h),!N.url)return T("[SharepointPlus 'get']: not able to find the URL!");if(C.fields=C.fields||"",C.where=C.where||"",C.whereFct=C.whereFct||function(e){return e},C.orderby=C.orderby||"",C.useIndexForOrderBy=!0===C.useIndexForOrderBy,C.groupby=C.groupby||"",C.rowlimit=C.rowlimit||0,C.whereEscapeChar=!1!==C.whereEscapeChar,C.paging=!0===C.paging,C.page=!1===C.paging||isNaN(C.page)?5e3:C.page,C.paging&&0===C.rowlimit&&(C.rowlimit=5e3),C.expandUserField=!0===C.expandUserField||"True"===C.expandUserField?"True":"False",C.dateInUTC=!0===C.dateInUTC?"True":"False",C.folderOptions=C.folderOptions||null,C.view=C.view||"",C.calendar=!0===C.calendar,!0===C.calendar&&(C.calendarOptions=C.calendarOptions||{},C.calendarOptions.referenceDate=C.calendarOptions.referenceDate||new Date,"string"!=typeof C.calendarOptions.referenceDate&&(C.calendarOptions.referenceDate=N.toSPDate(C.calendarOptions.referenceDate)),C.calendarOptions.splitRecurrence=!1===C.calendarOptions.splitRecurrence?"FALSE":"TRUE",C.calendarOptions.range=C.calendarOptions.range||"Month"),C.results=C.results||[],C.listItemCollectionPositionNext=C.listItemCollectionPositionNext||"",C.listItemCollectionPositionNext&&(C.listItemCollectionPositionNext=C.listItemCollectionPositionNext.replace(/&/g,"&amp;").replace(/&amp;amp;/g,"&amp;")),Array.isArray(C.where)?(C.where=C.where.slice(0),C.originalWhere||(C.originalWhere=C.where.slice(0)),C.nextWhere=C.where.slice(1),C.where=C.where.shift()):(C.originalWhere=C.where,C.nextWhere=[]),C.progress=C.progress||function(){},""===C.view){var e,t,r,n,i,o,a,s,l="",u="",c="",d="",f="";if(0<C.fields.length)for("string"==typeof C.fields&&(C.fields=C.fields.replace(/^\s+/,"").replace(/\s+$/,"").replace(/( )?,( )?/g,",").split(",")),e=0;e<C.fields.length;e++)l+='<FieldRef Name="'+C.fields[e]+'" />';if(""!==C.orderby)for(t=C.orderby.split(","),e=0;e<t.length;e++)r="ASC",0<(n=t[e].trim().split(" ")).length&&(2==n.length&&(r=n[1].toUpperCase()),u+='<FieldRef Name="'+n[0]+'" Ascending="'+("ASC"==r)+'" />');if(!0!==C.calendar&&!0!==C.calendarViaView||""!==u||(u='<FieldRef Name="EventDate" Ascending="ASC" />'),""!==C.groupby)for(i=C.groupby.split(","),e=0;e<i.length;e++)c+='<FieldRef Name="'+i[e]+'" />';if(Array.isArray(C.merge)&&(C.mergeData=C.mergeData||[]),!0===C.calendar||!0===C.calendarViaView)for(o=["Title","EventDate","EndDate","Duration","fAllDayEvent","fRecurrence","RecurrenceData","ID","MasterSeriesItemID","UID","RecurrenceID"],e=0;e<o.length;e++)l+='<FieldRef Name="'+o[e]+'" />';if(C.queryOptions===R)if(C._queryOptions="<DateInUtc>"+C.dateInUTC+'</DateInUtc><Paging ListItemCollectionPositionNext="'+C.listItemCollectionPositionNext+'"></Paging><IncludeAttachmentUrls>True</IncludeAttachmentUrls>'+(""===l?"":"<IncludeMandatoryColumns>False</IncludeMandatoryColumns>")+"<ExpandUserField>"+C.expandUserField+"</ExpandUserField>",C.folderOptions){switch(C.folderOptions.show){case"FilesAndFolders_Recursive":a="RecursiveAll";break;case"FilesOnly_InFolder":a="FilesOnly";break;case"FilesAndFolders_InFolder":a="";break;case"FilesOnly_Recursive":default:a="Recursive"}C._queryOptions+='<ViewAttributes Scope="'+a+'"></ViewAttributes>',C.folderOptions.path&&(C._queryOptions+="<Folder>"+N.url+"/"+N.listID+"/"+C.folderOptions.path+"</Folder>")}else C._queryOptions+='<ViewAttributes Scope="Recursive"></ViewAttributes>';else C._queryOptions=C.queryOptions;C.calendarOptions&&(C._queryOptions+="<CalendarDate>"+C.calendarOptions.referenceDate+"</CalendarDate><RecurrencePatternXMLVersion>v3</RecurrencePatternXMLVersion><ExpandRecurrence>"+C.calendarOptions.splitRecurrence+"</ExpandRecurrence>"),""!==C.where&&(f=C.whereCAML?C.where:N.parse(C.where)),!0===C.calendar&&(s="<DateRangesOverlap><FieldRef Name='EventDate' /><FieldRef Name='EndDate' /><FieldRef Name='RecurrenceID' /><Value Type='DateTime'><"+C.calendarOptions.range+" /></Value></DateRangesOverlap>",f=""!==f?"<And>"+f+s+"</And>":s),f=C.whereFct(f),d="<listName>"+N.listID+"</listName><viewName>"+(C.viewID||"")+"</viewName><query><Query>"+(""!=f?"<Where>"+f+"</Where>":"")+(""!=c?"<GroupBy>"+c+"</GroupBy>":"")+(""!=u?"<OrderBy"+(C.useIndexForOrderBy?" UseIndexForOrderBy='TRUE' Override='TRUE'":"")+">"+u+"</OrderBy>":"")+"</Query></query><viewFields><ViewFields Properties='True'>"+l+"</ViewFields></viewFields><rowLimit>"+C.rowlimit+"</rowLimit><queryOptions><QueryOptions>"+C._queryOptions+"</QueryOptions></queryOptions>",d=N._buildBodyForSOAP("GetListItems",d),N.ajax({url:N.url+"/_vti_bin/Lists.asmx",body:d}).then(function(e){var t,r,n,i,o,a,s,l,u,c,d,f,h,p,g,m,S,y,_,w,A,v,D,I,P,E;if(0===(t=e.getElementsByTagName("z:row")).length&&(t=e.getElementsByTagName("row")),I=function(e,t){for(var r=e.length,n=new Array(r),i=r/8,o=r%8,a=r-1;-1<a;a--){var s=i,l=o;do{switch(l){case 0:n[a]=t(e[a]),a--;case 7:n[a]=t(e[a]),a--;case 6:n[a]=t(e[a]),a--;case 5:n[a]=t(e[a]),a--;case 4:n[a]=t(e[a]),a--;case 3:n[a]=t(e[a]),a--;case 2:n[a]=t(e[a]),a--;case 1:n[a]=t(e[a]),a--}l=0}while(0<--s)}return n}(t,function(e){return O(e)}),0<C.results.length)for(r=0,i=I.length;r<i;r++)C.results.push(I[r]);if("string"!=typeof C.originalWhere&&C.progress(C.originalWhere.length-C.nextWhere.length,C.originalWhere.length),C.paging&&(void 0!==(o=e.getElementsByTagName("rs:data")[0])&&0!=o.length||(o=e.getElementsByTagName("data")[0]),o&&(d=o.getAttribute("ListItemCollectionPositionNext"))),C.paging&&0<--C.page){if(0===C.results.length&&(C.results=I),C.progress(C.results.length),d)return C.listItemCollectionPositionNext=N._cleanString(d),void N.get(C).then(function(e){b(e)},function(e){T(e)});I=C.results}else{if(0<C.nextWhere.length)return 0===C.results.length&&(C.results=I),C.where=C.nextWhere.slice(0),void N.get(C).then(function(e){b(e)},function(e){T(e)});C.where=C.originalWhere,I=0<C.results.length?C.results:I}if(C.joinData){for(s=[],l="",c={length:0},(a=C.joinData.noindex).length||alert("$SP.get() -- Error 'get': you must define the ON clause when JOIN is used."),r=0,i=I.length;r<i;r++){for(u="",n=0;n<a.length;n++)u+="_"+N.getLookup(I[r].getAttribute(a[n][N.listID])).id;if(C.joinData[u])for(l!==u&&(c[C.joinIndex[u]]||c.length++,c[C.joinIndex[u]]=!0,l=u),n=0,f=C.joinData[u].length;n<f;n++){for(h=[],m=(g=I[r].getAttributes()).length;m--;)h[N.listID+"."+g[m].nodeName.slice(4)]=g[m].nodeValue;for(m in C.joinData[u][n].getAttributes())h[m]=C.joinData[u][n].getAttribute(m);s.push(new L(h))}C.innerjoin&&(C.join=C.innerjoin),C.outerjoin&&(C.join=C.outerjoin,C.join.outer=!0)}if(I=s,C.where&&C.onLookupWhere&&C.outer)(C.where.startsWith("<")?C.where:N.parse(C.where))!==(C.onLookupWhere.startsWith("<")?C.onLookupWhere:N.parse(C.onLookupWhere))&&(C.outer=!1);if(C.outer&&(S=C.joinIndex.length,c.length<S))for(r=0;r<S;r++)if(!0!==c[r]){if((y=C.joinIndex[r])===R||C.joinData[y]===R)continue;for(n=0,f=C.joinData[y].length;n<f;n++){for(m in h=[],C.joinData[y][n].getAttributes())h[m]=C.joinData[y][n].getAttribute(m);s.push(new L(h))}}}if(C.outerjoin?(C.join=C.outerjoin,C.join.outer=!0):C.innerjoin&&(C.join=C.innerjoin),C.join){for(w=[],A=[],v=[],C.join.onLookup&&(C.join.on="'"+C.join.list+"'."+C.join.onLookup+" = '"+N.listID+"'.ID"),a=N._parseOn(C.join.on),w.noindex=a,r=0,i=I.length;r<i;r++){for(u="",h=[],n=0;n<a.length;n++)u+="_"+N.getLookup(I[r].getAttribute(a[n][N.listID])||I[r].getAttribute(N.listID+"."+a[n][N.listID])).id;if(w[u]||(A[u]=A.length,A.push(u),w[u]=[],C.join.onLookup&&"_"!==u&&v.push("~"+u.slice(1))),C.joinData)w[u].push(I[r]);else{for(n=(p=I[r].getAttributes()).length;n--;)h[N.listID+"."+p[n].nodeName.slice(4)]=p[n].nodeValue;w[u].push(new L(h))}}if(delete C.joinData,C.join.onLookup){if(0<v.length){for(D=SPArrayChunk(v,60),n=0;n<D.length;n++)D[n]=C.join.onLookup+' IN ["'+D[n].join('","')+'"]';D.length<=_SP_MAXWHERE_ONLOOKUP?(D="("+D.join(" OR ")+")",C.join.where?Array.isArray(C.join.where)?C.join.where.forEach(function(e,t){C.join.where[t]=D+" AND ("+e+")"}):C.join.where=D+" AND ("+C.join.where+")":C.join.where=D,C.join.onLookupWhere=D):C.join.paging=!0}C.join.fields||(C.join.fields=[]),Array.isArray(C.join.fields)?C.join.fields.push(C.join.onLookup):((h=C.join.fields.split(",")).push(C.join.onLookup),C.join.fields=h.join(","))}return _=N.list(C.join.list,C.join.url||N.url),C.join.joinData=w,C.join.joinIndex=A,void _.get(C.join).then(function(e){b(e)},function(e){T(e)})}if(C.merge){if(E={list:C.list||N.listID,url:C.url||N.url},0<C.merge.length)return(P=C.merge.shift()).merge=C.merge.slice(0),_=N.list(P.list,P.url||N.url),P.mergeData=C.mergeData.concat(I.map(function(e){return e.Source=E,e})),void _.get(P).then(function(e){b(e)},function(e){T(e)});I=C.mergeData.concat(I.map(function(e){return e.Source=E,e}))}I.NextPage=d,b(I)},function(e){T(e)})}else N.view(C.view).then(function(e){C.view=e.ID;var t=C.whereCAML?C.where:N.parse(C.where),r=e.WhereCAML.match(/^<And>(<DateRangesOverlap>.*<\/DateRangesOverlap>)(.*)<\/And>$/);r&&3===r.length&&(e.WhereCAML="<And>"+r[2]+r[1]+"</And>"),t+=e.WhereCAML,""!==C.where&&""!==e.WhereCAML&&(t="<And>"+t+"</And>"),C.where=t,C.fields+=(""===C.fields?"":",")+e.Fields.join(","),C.orderby+=(""===C.orderby?"":",")+e.OrderBy,C.whereCAML=!0,C.useOWS=!0,C.calendarViaView=C.calendar,C.calendar=!1,delete C.view,N.get(C).then(function(e){b(e)},function(e){T(e)})}).catch(function(e){T(e)})})},createFile:function(a){var s=this;return s._promise(function(i,o){if(s.needQueue)return s._addInQueue("createFile",arguments);if((a=a||{}).content===R)throw"[SharepointPlus 'createFile']: the file content is required.";if(a.filename===R)throw"[SharepointPlus 'createFile']: the filename is required.";if(!s.listID)throw"[SharepointPlus 'createFile']: the library name is required.";if(!s.url)throw"[SharepointPlus 'createFile']: not able to find the URL!";a.extendedFields=a.extendedFields||"",a.progress=a.progress||function(){},a.getXHR=a.getXHR||function(){},s.hasREST().then(function(e){if(e){var r={};s.info().then(function(e){var t=e._List.RootFolder,r=a.filename.split("/"),n=a.filename;r=t+(r=1<r.length?(n=r.slice(-1)[0],"/"+r.slice(0,-1).join("/")):"");var i=n.replace(/[\*\?\|:"'<>#{}%~&]/g,"").replace(/^[\. ]+|[\. ]+$/g,"").replace(/ {2,}/g," ").replace(/\.{2,}/g,".");128<=i.length&&(i=i.slice(0,115)+"__"+i.slice(-8));var o=s.url+"/_api/web/GetFolderByServerRelativeUrl('"+encodeURIComponent(r)+"')/files/add(url='"+encodeURIComponent(i)+"',overwrite=true)";return"undefined"!=typeof Blob&&(a.content=new Blob([a.content])),s.ajax({url:o,body:a.content,onprogress:function(e){e.lengthComputable&&a.progress(parseInt(e.loaded/e.total*100))},getXHR:a.getXHR})}).then(function(e){if(SPExtend(!0,r,e.d),r.Url=r.__metadata.uri.split("/").slice(0,3).join("/")+e.d.ServerRelativeUrl,r.AllFieldsUrl=e.d.ListItemAllFields.__deferred.uri,a.fields)return s.ajax({url:r.AllFieldsUrl});i(r)}).then(function(e){SPExtend(!0,r,e.d);var t={ID:r.ID};return SPExtend(t,a.fields),s.update(t)}).then(function(e){if(0<e.failed.length)o("File '"+r.Url+"' added, but fields not updated: "+e.failed[0].errorMessage);else{for(var t in e=e.passed[0])r[t]=e[t];i(r)}}).catch(function(e){o(e)})}else{if(a.fields&&!a.extendedFields)return void s.info().then(function(e){for(var t=e.length;t--;)a.fields[e[t].StaticName]&&(a.extendedFields+='<FieldInformation Type="'+e[t].Type+'" Value="'+a.fields[e[t].StaticName]+'" DisplayName="'+e[t].StaticName+'" InternalName="'+e[t].StaticName+'" />');a.extendedFields||delete a.fields,a.useCallback?s.createFile(a):s.createFile(a).then(function(e){i(e)},function(e){o(e)})});var n="/"+s.listID+"/"+a.filename;"http"!==(n=(s.url+n).replace(/([^:]\/)\//g,"$1")).slice(0,4)&&(n=h.location.protocol+"//"+h.location.host+n),a.content=SPArrayBufferToBase64(a.content);var t="<SourceUrl>http://null</SourceUrl><DestinationUrls><string>"+n+'</string></DestinationUrls><Fields><FieldInformation Type="File" />'+a.extendedFields+"</Fields><Stream>"+a.content+"</Stream>";t=s._buildBodyForSOAP("CopyIntoItems",t),s.ajax({url:s.url+"/_vti_bin/copy.asmx",body:t,onprogress:function(e){e.lengthComputable&&a.progress(parseInt(e.loaded/e.total*100))},getXHR:a.getXHR,headers:{SOAPAction:"http://schemas.microsoft.com/sharepoint/soap/CopyIntoItems"}}).then(function(e){var t=e.getElementsByTagName("CopyResult");(t=0<t.length?t[0]:null)&&"Success"!==t.getAttribute("ErrorCode")?o("[SharepointPlus 'createFile'] Error creating ("+n+"): "+t.getAttribute("ErrorCode")+" - "+t.getAttribute("ErrorMessage")):i({Url:n,Name:a.filename})},function(e){o(e)})}})})},createFolder:function(a){var s=this;return s._promise(function(r,n){if(s.needQueue)return s._addInQueue("createFolder",arguments);if(a===R)throw"[SharepointPlus 'createFolder']: the folder path is required.";var e,t=a.replace(/[\*\?\|:"'<>#{}%~&]/g,"").replace(/^[\. ]+|[\. ]+$/g,"").replace(/ {2,}/g," ").replace(/\.{2,}/g,"."),i=[],o="";for("/"===t.charAt(0)&&(t=t.slice(1)),"/"===t.slice(-1)&&(t=t.slice(0,-1)),t=t.split("/"),e=0;e<t.length;e++)o+=(0<e?"/":"")+t[e],i.push({FSObjType:1,BaseName:o});s.add(i).then(function(e){var t;for("/"===a.charAt(0)&&(a=a.slice(1)),"/"===a.slice(-1)&&(a=a.slice(0,-1)),t=e.passed.length;t--;)if(e.passed[t].BaseName===a)return void r(e.passed[t]);for(t=e.failed.length;t--;)if(e.failed[t].BaseName===a)return void(-1<e.failed[t].errorMessage.indexOf("0x8107090d")?(e.failed[t].errorMessage="Folder '"+e.failed[t].BaseName+"' already exists.",r(e.failed[t])):n(e.failed[t].errorMessage));n("Unknown error")}).catch(function(e){n(e)})})},checkin:function(t){var i=this;return i._promise(function(r,n){if(!(t=t||{}).destination)throw"[SharepointPlus 'checkin'] the file destination path is required.";i.url&&!t.url&&(t.url=i.url),t.url?(t.comments=(t.comments||"").replace(/&/g,"&amp;"),i.ajax({url:t.url+"/_vti_bin/Lists.asmx",body:i._buildBodyForSOAP("CheckInFile","<pageUrl>"+t.destination+"</pageUrl><comment>"+t.comments+"</comment><CheckinType>1</CheckinType>"),headers:{SOAPAction:"http://schemas.microsoft.com/sharepoint/soap/CheckInFile"}}).then(function(e){var t=e.getElementsByTagName("CheckInFileResult");(t=0<t.length?t[0]:null)&&"true"!=t.firstChild.nodeValue?n(t):r()},function(e){n(e)})):i.getURL().then(function(e){return t.url=e,i.checkin(t)}).then(function(e){r(e)}).catch(function(e){n(e)})})},addAttachment:function(t){var o=this;return o._promise(function(n,i){if(o.needQueue)return o._addInQueue("addAttachment",arguments);if(0===arguments.length)throw"[SharepointPlus 'addAttachment'] the arguments are mandatory.";if(!o.listID)throw"[SharepointPlus 'addAttachment'] the list ID/Name is required.";if(!o.url)throw"[SharepointPlus 'addAttachment'] not able to find the URL!";if(!t.ID)throw"[SharepointPlus 'addAttachment'] the item ID is required.";if(!t.filename)throw"[SharepointPlus 'addAttachment'] the filename is required.";if(!t.attachment)throw"[SharepointPlus 'addAttachment'] the ArrayBuffer of the attachment's content is required.";var e=t.filename.replace(/[\*\?\|\\/:"'<>#{}%~&]/g,"").replace(/^[\. ]+|[\. ]+$/g,"").replace(/ {2,}/g," ").replace(/\.{2,}/g,".");128<=e.length&&(e=e.slice(0,115)+"__"+e.slice(-8)),o.ajax({url:o.url+"/_vti_bin/Lists.asmx",body:o._buildBodyForSOAP("AddAttachment","<listName>"+o.listID+"</listName><listItemID>"+t.ID+"</listItemID><fileName>"+e+"</fileName><attachment>"+SPArrayBufferToBase64(t.attachment)+"</attachment>"),headers:{SOAPAction:"http://schemas.microsoft.com/sharepoint/soap/AddAttachment"}}).then(function(e){var t=e.getElementsByTagName("AddAttachmentResult"),r="";(t=0<t.length?t[0]:null)&&(r=o.url+"/"+t.firstChild.nodeValue),r?n(r):i(t)}).catch(function(e){i(e)})})},getAttachment:function(e){var r=this;return r._promise(function(i,t){if(r.needQueue)return r._addInQueue("getAttachment",arguments);if(!r.listID)throw"[SharepointPlus 'getAttachment']: the list ID/Name is required";if(!r.url)throw"[SharepointPlus 'getAttachment']: not able to find the URL!";r.ajax({url:r.url+"/_vti_bin/lists.asmx",body:r._buildBodyForSOAP("GetAttachmentCollection","<listName>"+r.listID+"</listName><listItemID>"+e+"</listItemID>"),headers:{SOAPAction:"http://schemas.microsoft.com/sharepoint/soap/GetAttachmentCollection"}}).then(function(e){for(var t=[],r=0,n=e.getElementsByTagName("Attachment");r<n.length;r++)t.push(n[r].firstChild.nodeValue);i(t)},function(e){t(e)})})},getContentTypes:function(r){var a=this;return a._promise(function(o,t){if(a.needQueue)return a._addInQueue("getContentTypes",arguments);if(!a.listID)throw"[SharepointPlus 'getContentTypes'] the list ID/name is required.";if(!a.url)throw"[SharepointPlus 'getContentTypes'] not able to find the URL!";if((r=r||{cache:!0}).cache)for(var e=0;e<_SP_CACHE_CONTENTTYPES.length;e++)if(_SP_CACHE_CONTENTTYPES[e].list===a.listID&&_SP_CACHE_CONTENTTYPES[e].url===a.url)return void o(_SP_CACHE_CONTENTTYPES[e].contentTypes);a.ajax({url:a.url+"/_vti_bin/lists.asmx",body:a._buildBodyForSOAP("GetListContentTypes","<listName>"+a.listID+"</listName>"),headers:{SOAPAction:"http://schemas.microsoft.com/sharepoint/soap/GetListContentTypes"}}).then(function(e){for(var t,r=e.getElementsByTagName("ContentType"),n=0,i=[];n<r.length;n++)(t=r[n].getAttribute("ID"))&&i.push({ID:t,Name:r[n].getAttribute("Name"),Description:r[n].getAttribute("Description")});_SP_CACHE_CONTENTTYPES.push({list:a.listID,url:a.url,contentTypes:i}),o(i)},function(e){t(e)})})},getContentTypeInfo:function(S,i){var y=this;return y._promise(function(m,n){if(y.needQueue)return y._addInQueue("getContentTypeInfo",arguments);if(!y.listID)throw"[SharepointPlus 'getContentTypeInfo'] the list ID/Name is required.";if(1<=arguments.length&&"string"!=typeof S)throw"[SharepointPlus 'getContentTypeInfo'] the Content Type Name/ID is required.";if(!y.url)throw"[SharepointPlus 'getContentTypeInfo'] not able to find the URL!";if((i=i||{cache:!0}).cache)for(var e=0;e<_SP_CACHE_CONTENTTYPE.length;e++)_SP_CACHE_CONTENTTYPE[e].list===y.listID&&_SP_CACHE_CONTENTTYPE[e].url===y.url&&_SP_CACHE_CONTENTTYPE[e].contentType===S&&m(_SP_CACHE_CONTENTTYPE[e].info);"0x"===S.slice(0,2)?y.ajax({url:y.url+"/_vti_bin/lists.asmx",body:y._buildBodyForSOAP("GetListContentType","<listName>"+y.listID+"</listName><contentTypeId>"+S+"</contentTypeId>"),headers:{SOAPAction:"http://schemas.microsoft.com/sharepoint/soap/GetListContentType"}}).then(function(e){var t,r,n,i,o,a,s,l,u,c,d,f,h=[],p=e.getElementsByTagName("Field"),g=0;for(t=0;t<p.length;t++)if(p[t].getAttribute("ID")){for(h[g]=[],s=h[g],r=(l=p[t].attributes).length;r--;){if(u=l[r].nodeName,d=l[r].nodeValue,"Type"===u)switch(d){case"Choice":case"MultiChoice":for(s.FillInChoice=p[t].getAttribute("FillInChoice"),n=p[t].getElementsByTagName("CHOICE"),i=[],o=0;o<n.length;o++)i.push(n[o].firstChild.nodeValue);s.Choices=i;break;case"Lookup":case"LookupMulti":s.Choices={list:p[t].getAttribute("List"),field:p[t].getAttribute("ShowField")};break;default:s.Choices=[]}s[u]=d}if(0<(c=p[t].getElementsByTagName("Default").length)){for(f=p[t].getElementsByTagName("Default"),h[g].DefaultValue=[],a=0;a<c;a++)f[a].firstChild&&h[g].DefaultValue.push(f[a].firstChild.nodeValue);1===c&&(h[g].DefaultValue=h[g].DefaultValue[0])}else h[g].DefaultValue=null;g++}_SP_CACHE_CONTENTTYPE.push({list:y.listID,url:y.url,contentType:S,info:h}),m(h)},function(e){n(e)}):y.getContentTypes(i).then(function(e){for(var t=!1,r=e.length;r--;)if(e[r].Name===S){y.getContentTypeInfo(e[r].ID,i).then(function(e){m(e)},function(e){n(e)}),t=!0;break}if(!t)throw"[SharepointPlus 'getContentTypeInfo'] not able to find the Content Type called '"+S+"' at "+y.url}).catch(function(e){n(e)})})},info:function(){var e=this;return e._promise(function(_,t){if(e.needQueue)return e._addInQueue("info",arguments);if(!e.listID)throw"[SharepointPlus 'info'] the list ID/Name is required.";if(!e.url)throw"[SharepointPlus 'info'] not able to find the URL!";e.ajax({url:e.url+"/_vti_bin/lists.asmx",body:e._buildBodyForSOAP("GetList","<listName>"+e.listID+"</listName>"),headers:{SOAPAction:"http://schemas.microsoft.com/sharepoint/soap/GetList"}}).then(function(e){var t,r,n,i,o,a,s,l,u,c,d,f,h,p=[],g=e.getElementsByTagName("Field"),m=0,S=e.getElementsByTagName("List");for(r=(S=0<S.length?S[0]:null).attributes,p._List={},s=0;s<r.length;s++)p._List[r[s].nodeName]=r[s].nodeValue;for(s=0;s<g.length;s++)if(g[s].getAttribute("ID")){for(p[m]=[],t=p[m],l=(r=g[s].attributes).length;l--;){if(n=r[l].nodeName,i=r[l].nodeValue,"Type"===n)switch(i){case"Choice":case"MultiChoice":for(t.FillInChoice=g[s].getAttribute("FillInChoice"),u=g[s].getElementsByTagName("CHOICE"),c=[],d=0;d<u.length;d++)c.push(u[d].firstChild.nodeValue);t.Choices=c;break;case"Lookup":case"LookupMulti":t.Choices={list:g[s].getAttribute("List"),field:g[s].getAttribute("ShowField")};break;case"TaxonomyFieldType":case"TaxonomyFieldTypeMulti":for(u=g[s].getElementsByTagName("Property"),t.Property={},d=0;d<u.length;d++)f=u[d].getElementsByTagName("Name"),h=u[d].getElementsByTagName("Value"),0<f.length&&(t.Property[f[0].firstChild.nodeValue]=0<h.length?h[0].firstChild.nodeValue:null);break;default:t.Choices=[]}t[n]=i}if(0<(o=g[s].getElementsByTagName("Default").length)){a=g[s].getElementsByTagName("Default"),p[m].DefaultValue=[];for(var y=0;y<o;y++)a[y].firstChild&&p[m].DefaultValue.push(a[y].firstChild.nodeValue);1===o&&(p[m].DefaultValue=p[m].DefaultValue[0])}else p[m].DefaultValue=null;m++}_(p)},function(e){t(e)})})},view:function(u,e){var c=this;return c._promise(function(a,t){if(c.needQueue)return c._addInQueue("view",arguments);if(!c.listID)return t("[SharepointPlus 'view'] the list ID/Name is required.");if(!u)return t("[SharepointPlus 'view'] the view ID/Name is required.");var r,s=c.listID,l=!1;if((e=e||{}).cache=!1!==e.cache,!c.url)return t("[SharepointPlus 'view'] not able to find the URL!");e.cache&&(_SP_CACHE_SAVEDVIEW.forEach(function(e){e.url!==c.url||e.list!==s||e.viewID!==u&&e.viewName!==u||(l=!0,a(e.data))}),l)||("{"===u.charAt(0)?c.ajax({url:c.url+"/_vti_bin/Views.asmx",body:c._buildBodyForSOAP("GetView","<listName>"+c.listID+"</listName><viewName>"+u+"</viewName>"),headers:{SOAPAction:"http://schemas.microsoft.com/sharepoint/soap/GetView"}}).then(function(e){var t,r,n=e.getElementsByTagName("View"),i={DefaultView:"TRUE"==(n=0<n.length?n[0]:null).getAttribute("DefaultView"),Name:n.getAttribute("DisplayName"),ID:u,Type:n.getAttribute("Type"),Url:n.getAttribute("Url"),OrderBy:[],Fields:[],RowLimit:"",WhereCAML:"",Node:n},o=e.getElementsByTagName("ViewFields")[0].getElementsByTagName("FieldRef");for(t=0;t<o.length;t++)i.Fields.push(o[t].getAttribute("Name"));if(o=0<(o=e.getElementsByTagName("OrderBy")).length?o[0]:null){for(o=o.getElementsByTagName("FieldRef"),t=0;t<o.length;t++)i.OrderBy.push(o[t].getAttribute("Name")+" "+(o[t].getAttribute("Ascending")==R?"ASC":"DESC"));i.OrderBy=i.OrderBy.join(",")}else i.OrderBy="";(r=0<(r=e.getElementsByTagName("Where")).length?r[0]:null)&&2==(r=(r=r.xml||(new XMLSerializer).serializeToString(r)).match(/<Where [^>]+>(.*)<\/Where>/)).length&&(i.WhereCAML=r[1]),l=!1,_SP_CACHE_SAVEDVIEW.forEach(function(e){e.url!==c.url||e.list!==s||e.viewID!==u&&e.viewName!==u||(e.data=i,l=!0)}),l||_SP_CACHE_SAVEDVIEW.push({url:c.url,list:c.listID,data:i,viewID:u,viewName:i.Name}),a(i)},function(e){t(e)}):c.views().then(function(e){for(l=!1,r=e.length;r--;)if(e[r].Name===u){c.view(e[r].ID).then(function(e){a(e)},function(e){t(e)}),l=!0;break}if(!l)return t("[SharepointPlus 'view'] not able to find the view called '"+u+"' for list '"+c.listID+"' at "+c.url)}))})},views:function(e){var a=this;return a._promise(function(o,t){if(a.needQueue)return a._addInQueue("views",arguments);if(!a.listID)throw"[SharepointPlus 'views'] the list ID/Name is required.";if((e=e||{}).cache=!1!==e.cache,!a.url)throw"[SharepointPlus 'views'] not able to find the URL!";var r=!1;e.cache&&(_SP_CACHE_SAVEDVIEWS.forEach(function(e){e.url===a.url&&e.listID===a.listID&&(r=!0,o(e.data))}),r)||a.ajax({url:a.url+"/_vti_bin/Views.asmx",body:a._buildBodyForSOAP("GetViewCollection","<listName>"+a.listID+"</listName>"),headers:{SOAPAction:"http://schemas.microsoft.com/sharepoint/soap/GetViewCollection"}}).then(function(e){for(var t=[],r=e.getElementsByTagName("View"),n=0,i=!1;n<r.length;n++)t[n]={ID:r[n].getAttribute("Name"),Name:r[n].getAttribute("DisplayName"),Url:r[n].getAttribute("Url"),DefaultView:"TRUE"==r[n].getAttribute("DefaultView"),Type:r[n].getAttribute("Type"),Node:r[n]};_SP_CACHE_SAVEDVIEWS.forEach(function(e){e.url===a.url&&e.listID===a.listID&&(e.data=t,i=!0)}),i||_SP_CACHE_SAVEDVIEWS.push({url:a.url,listID:a.listID,data:t}),o(t)},function(e){t(e)})})},lists:function(l){var r=this;return r._promise(function(a,t){if((l=l||{}).url){l.cache=!1!==l.cache;var s=!1;l.cache&&(_SP_CACHE_SAVEDLISTS.forEach(function(e){e.url===l.url&&(s=!0,a(e.data))}),s)||r.ajax({url:l.url+"/_vti_bin/lists.asmx",body:r._buildBodyForSOAP("GetListCollection",""),headers:{SOAPAction:"http://schemas.microsoft.com/sharepoint/soap/GetListCollection"}}).then(function(e){var t,r,n,i=[],o=e.getElementsByTagName("List");for(t=0;t<o.length;t++){for(i[t]={},r=(n=o[t].attributes).length;r--;)i[t][n[r].nodeName]=n[r].nodeValue;i[t].Url=o[t].getAttribute("DefaultViewUrl"),i[t].Name=o[t].getAttribute("Title")}s=!1,l.cache&&_SP_CACHE_SAVEDLISTS.forEach(function(e){e.url===l.url&&(s=!0)}),s||_SP_CACHE_SAVEDLISTS.push({url:l.url,data:i}),a(i)}).catch(function(e){t(e)})}else r.getURL().then(function(e){return l.url=e,r.lists(l)}).then(function(e){a(e)}).catch(function(e){t(e)})})},add:function(d,f){var h=this;return h._promise(function(s,l){if(h.needQueue)return h._addInQueue("add",arguments);if(!h.listID)throw"[SharepointPlus 'add'] the list ID/Name is required.";if(!h.url)throw"[SharepointPlus 'add'] not able to find the URL!";var u={};SPExtend(!0,u,f),u.escapeChar=u.escapeChar==R||u.escapeChar,u.progress=u.progress||function(){},u.packetsize=u.packetsize||15,u.rootFolder=u.rootFolder||"",Array.isArray(d)||(d=[d]);var t,e,r,n,i,o,a=d.length;if(u.progressVar=u.progressVar||{current:0,max:a,passed:[],failed:[],eventID:"spAdd"+(""+Math.random()).slice(2)},a>u.packetsize)e=(t=d.slice(0)).splice(0,u.packetsize),_SP_ADD_PROGRESSVAR[u.progressVar.eventID]=function(e){return h.add(t,e)},a=(d=e).length;else if(0===a)return u.progress(1,1),void s({passed:[],failed:[]});u.progressVar.current+=a;var c='<Batch OnError="Continue" ListVersion="1"  ViewName=""'+(u.rootFolder?' RootFolder="'+u.rootFolder+'"':"")+">";for(o=0;o<d.length;o++){for(i in c+='<Method ID="'+(o+1)+'" Cmd="New">',c+="<Field Name='ID'>New</Field>",d[o])if(d[o].hasOwnProperty(i))switch(r=i,n=d[o][i],Array.isArray(n)&&(n=0===n.length?"":";#"+n.join(";#")+";#"),r){case"RecurrenceData":if("object"==typeof n&&(n=h.parseRecurrence(n)),void 0===d[o].fRecurrence&&(c+="<Field Name='fRecurrence'>1</Field>"),void 0===d[o].EventType&&(c+="<Field Name='EventType'>1</Field>"),void 0===d[o].UID&&(c+="<Field Name='UID'>{"+h.newGuid()+"}</Field>"),void 0===d[o].fAllDayEvent&&(c+="<Field Name='fAllDayEvent'>0</Field>"),void 0===d[o].TimeZone){if(!_SP_CACHE_TIMEZONEINFO[h.url])return h.getTimeZoneInfo({url:h.url}).then(function(e){return _SP_CACHE_TIMEZONEINFO[h.url]=e,h.add(d,f)}).then(function(e){s(e)}).catch(function(e){l(e)});c+="<Field Name='TimeZone'>"+_SP_CACHE_TIMEZONEINFO[h.url].ID+"</Field>"}c+="<Field Name='"+r+"'><![CDATA["+n+"]]></Field>";break;default:"boolean"==typeof n&&(n=n?"1":"0"),u.escapeChar&&"string"==typeof n&&(n=h._cleanString(n)),c+="<Field Name='"+r+"'>"+n+"</Field>"}c+="</Method>"}c+="</Batch>",h.ajax({url:h.url+"/_vti_bin/lists.asmx",body:h._buildBodyForSOAP("UpdateListItems","<listName>"+h.listID+"</listName><updates>"+c+"</updates>"),headers:{SOAPAction:"http://schemas.microsoft.com/sharepoint/soap/UpdateListItems"}}).then(function(e){var t,r,n=e.getElementsByTagName("Result"),i=n.length,o=u.progressVar.passed,a=u.progressVar.failed;for(t=0;t<i;t++)"0x00000000"===n[t].getElementsByTagName("ErrorCode")[0].firstChild.nodeValue?(0==(r=n[t].getElementsByTagName("z:row")).length&&(r=n[t].getElementsByTagName("row")),d[t]&&(d[t].ID=r[0].getAttribute("ows_ID"),d[t].raw=r[0],o.push(d[t]))):d[t]&&(d[t].errorMessage=n[t].getElementsByTagName("ErrorText")[0].firstChild.nodeValue,a.push(d[t]));u.progress(u.progressVar.current,u.progressVar.max),u.progressVar.current<u.progressVar.max?_SP_ADD_PROGRESSVAR[u.progressVar.eventID]&&_SP_ADD_PROGRESSVAR[u.progressVar.eventID](u).then(function(e){s(e)},function(e){l(e)}):(_SP_ADD_PROGRESSVAR[u.progressVar.eventID]&&delete _SP_ADD_PROGRESSVAR[u.progressVar.eventID],s({passed:o,failed:a}))},function(e){l(e)})})},update:function(f,h){var p=this;return p._promise(function(s,l){if(p.needQueue)return p._addInQueue("update",arguments);if(!p.listID)return l("[SharepointPlus 'update'] the list ID/name is required.");if(!p.url)return l("[SharepointPlus 'update'] not able to find the URL!");var u={};SPExtend(!0,u,h),u.where=u.where||"",u.escapeChar=u.escapeChar==R||u.escapeChar,u.progress=u.progress||function(){},u.packetsize=u.packetsize||15,Array.isArray(f)||(f=[f]);var t,e,r,n,i,o,a=f.length;if(1===a&&u.where){delete f[0].ID;var c=[];new Promise(function(t,r){var n={fields:["ID"],where:u.where};u.event?(n.calendar=!0,n.calendarOptions={referenceDate:u.event},p.get({fields:"ContentType",where:u.where}).then(function(e){return 0===e.length?Promise.reject("[SharepointPlus 'update'] Unable to find an event with `"+u.where+"`"):p.getContentTypeInfo(e[0].getAttribute("ContentType")||"Event")}).then(function(e){e.forEach(function(e){var t=e.Name||e.StaticName;("TimeZone"===t||"_Hidden"!==e.Group&&"TRUE"!==e.ReadOnly&&"TRUE"!==e.Hidden&&void 0===f[0][t])&&n.fields.push(t)}),t(n)}).catch(function(e){r(e)})):t(n)}).then(function(e){return c=e.fields.slice(0),p.get(e)}).then(function(e){var r,t=function(e){var t={};for(var r in e)t[r]=e[r];return t},n=[],i=e.length;if(u.event){var o="string"!=typeof u.event?p.toSPDate(u.event):u.event.slice(0,10),a=e.filter(function(e){return-1!==e.getAttribute("ID").indexOf("."+o+"T")});return 0===a.length?Promise.reject("[SharepointPlus 'update'] No event found on "+o):(a=a[0],r=t(f[0]),c.forEach(function(e){if("ID"!==e&&void 0===r[e]){var t=a.getAttribute(e);t!==R&&null!==t&&(r[e]=t)}}),r.MasterSeriesItemID=a.getAttribute("ID").split(".")[0],r.UID=a.getAttribute("UID"),r.EventType=4,r.fRecurrence=1,r.RecurrenceData="No Recurrence",r.RecurrenceID=a.getAttribute("RecurrenceID"),r.TimeZone=a.getAttribute("TimeZone"),p.add(r,u))}for(;i--;)(r=t(f[0])).ID=e[i].getAttribute("ID"),n.push(r);return delete u.where,p.update(n,u)}).then(function(e){s(e)}).catch(function(e){l(e)})}else{if(u.progressVar=u.progressVar||{current:0,max:a,passed:[],failed:[],eventID:"spUpdate"+(""+Math.random()).slice(2)},a>u.packetsize)e=(t=f.slice(0)).splice(0,u.packetsize),_SP_UPDATE_PROGRESSVAR[u.progressVar.eventID]=function(e){return p.update(t,e)},a=(f=e).length;else if(0==a)return void s({passed:[],failed:[]});u.progressVar.current+=a;var d='<Batch OnError="Continue" ListVersion="1"  ViewName="">';for(o=0;o<a;o++){if(d+='<Method ID="'+(o+1)+'" Cmd="Update">',!f[o].ID)return l("[SharepointPlus 'update'] you have to provide the item ID called 'ID'");for(i in f[o])f[o].hasOwnProperty(i)&&(r=i,n=f[o][i],Array.isArray(n)&&(n=0===n.length?"":";#"+n.join(";#")+";#"),"RecurrenceData"===r?("object"==typeof n&&(n=p.parseRecurrence(n)),f[o].RecurrenceID||(void 0===f[o].fRecurrence&&(d+="<Field Name='fRecurrence'>1</Field>"),void 0===f[o].EventType&&(d+="<Field Name='EventType'>1</Field>"),void 0===f[o].UID&&(d+="<Field Name='UID'>{"+p.newGuid()+"}</Field>"),void 0===f[o].fAllDayEvent&&(d+="<Field Name='fAllDayEvent'>0</Field>")),d+="<Field Name='"+r+"'><![CDATA["+n+"]]></Field>"):("boolean"==typeof n&&(n=n?"1":"0"),u.escapeChar&&"string"==typeof n&&(n=p._cleanString(n)),d+="<Field Name='"+r+"'>"+n+"</Field>"));d+="</Method>"}d+="</Batch>",p.ajax({url:p.url+"/_vti_bin/lists.asmx",body:p._buildBodyForSOAP("UpdateListItems","<listName>"+p.listID+"</listName><updates>"+d+"</updates>"),headers:{SOAPAction:"http://schemas.microsoft.com/sharepoint/soap/UpdateListItems"}}).then(function(e){var t,r=e.getElementsByTagName("Result"),n=r.length,i=u.progressVar.passed,o=u.progressVar.failed;for(t=0;t<n;t++)if("0x00000000"===r[t].getElementsByTagName("ErrorCode")[0].firstChild.nodeValue&&f[t]){var a=r[t].getElementsByTagName("z:row");0===a.length&&(a=r[t].getElementsByTagName("row")),f[t].raw=a[0],i.push(f[t])}else f[t]&&(f[t].errorMessage=r[t].getElementsByTagName("ErrorText")[0].firstChild.nodeValue,o.push(f[t]));u.progress(u.progressVar.current,u.progressVar.max),u.progressVar.current<u.progressVar.max?_SP_UPDATE_PROGRESSVAR[u.progressVar.eventID]&&_SP_UPDATE_PROGRESSVAR[u.progressVar.eventID](u).then(function(e){s(e)},function(e){l(e)}):(_SP_UPDATE_PROGRESSVAR[u.progressVar.eventID]&&delete _SP_UPDATE_PROGRESSVAR[u.progressVar.eventID],s({passed:i,failed:o}))},function(e){l(e)})}})},history:function(e){var n=this;return n._promise(function(t,r){if(n.needQueue)return n._addInQueue("history",arguments);if(!n.listID)throw"[SharepointPlus 'history'] the list ID/Name is required.";if(!(e=e||{}).ID||!e.Name)throw"[SharepointPlus 'history'] you must provide the item ID and field Name.";n.ajax({url:n.url+"/_vti_bin/lists.asmx",body:n._buildBodyForSOAP("GetVersionCollection","<strlistID>"+n.listID+"</strlistID><strlistItemID>"+e.ID+"</strlistItemID><strFieldName>"+e.Name+"</strFieldName>"),headers:{SOAPAction:"http://schemas.microsoft.com/sharepoint/soap/GetVersionCollection"}}).then(function(e){t(e.getElementsByTagName("Version"))},function(e){r(e)})})},moderate:function(c,d){var f=this;return f._promise(function(l,u){if(f.needQueue)return f._addInQueue("moderate",arguments);if(!f.listID)throw"[SharepointPlus 'moderate'] the list ID/Name is required.";if(d=d||{},!f.url)throw"[SharepointPlus 'moderate'] not able to find the URL!";d.progress=d.progress||function(){},Array.isArray(c)||(c=[c]);var t,e,r,n,i,o,a=c.length;if(d.progressVar=d.progressVar||{current:0,max:a,passed:[],failed:[],eventID:"spModerate"+(""+Math.random()).slice(2)},15<a)return e=(t=c.slice(0)).splice(0,15),_SP_MODERATE_PROGRESSVAR[d.progressVar.eventID]=function(e){return f.moderate(t,e)},void f.moderate(e,d);if(0!==a){d.progressVar.current+=a;var s='<Batch OnError="Continue" ListVersion="1"  ViewName="">';for(o=0;o<a;o++){if(s+='<Method ID="'+(o+1)+'" Cmd="Moderate">',!c[o].ID)throw"[SharepointPlus 'moderate'] you have to provide the item ID called 'ID'";if(void 0===c[o].ApprovalStatus)throw"[SharepointPlus 'moderate'] you have to provide the approval status 'ApprovalStatus' (Approved, Rejected, Pending, Draft or Scheduled)";for(i in c[o]){if(c[o].hasOwnProperty(i)&&(r=i,n=c[o][i],"ApprovalStatus"==r))switch(r="_ModerationStatus",n.toLowerCase()){case"approve":case"approved":n=0;break;case"reject":case"deny":case"denied":case"rejected":n=1;break;case"pending":n=2;break;case"draft":n=3;break;case"scheduled":n=4;break;default:n=2}s+="<Field Name='"+r+"'>"+n+"</Field>"}s+="</Method>"}s+="</Batch>",f.ajax({url:f.url+"/_vti_bin/lists.asmx",body:f._buildBodyForSOAP("UpdateListItems","<listName>"+f.listID+"</listName><updates>"+s+"</updates>"),headers:{SOAPAction:"http://schemas.microsoft.com/sharepoint/soap/UpdateListItems"}}).then(function(e){var t,r,n=e.getElementsByTagName("Result"),i=n.length,o=d.progressVar.passed,a=d.progressVar.failed;for(r=0;r<i;r++){0==(t=n[r].getElementsByTagName("z:row")).length&&(t=e.getElementsByTagName("row"));var s=O(t[0]);"0x00000000"==n[r].getElementsByTagName("ErrorCode")[0].firstChild.nodeValue?o.push(s):(c[r].errorMessage=n[r].getElementsByTagName("ErrorText")[0].firstChild.nodeValue,a.push(c[r]))}d.progress(d.progressVar.current,d.progressVar.max),d.progressVar.current<d.progressVar.max?_SP_MODERATE_PROGRESSVAR[d.progressVar.eventID]&&_SP_MODERATE_PROGRESSVAR[d.progressVar.eventID](d).then(function(e){l(e)},function(e){u(e)}):(_SP_MODERATE_PROGRESSVAR[d.progressVar.eventID]&&delete _SP_MODERATE_PROGRESSVAR[d.progressVar.eventID],l({passed:o,failed:a}))},function(e){u(e)})}else d.after({passed:[],failed:[]})})},remove:function(u,c){var d=this;return d._promise(function(a,s){if(d.needQueue)return d._addInQueue("remove",arguments);if(!d.url)throw"[SharepointPlus 'remove'] not able to find the URL!";!c&&u.where&&(c=u,u=[]);var l={};SPExtend(!0,l,c),l.progress=l.progress||function(){},l.packetsize=l.packetsize||15,Array.isArray(u)||(u=[u]);var t,e,r,n=u.length;if(l.where){1===n&&delete u[0].ID;var i={fields:["ID","FileRef"],where:l.where};return l.event&&(i.fields.push("Title"),i.calendar=!0,i.calendarOptions={referenceDate:l.event}),void d.get(i).then(function(e){var t,r=function(e){var t={};for(var r in e)t[r]=e[r];return t},n=[],i=e.length,o={};if(l.event){var a="string"!=typeof l.event?d.toSPDate(l.event):l.event.slice(0,10),s=e.filter(function(e){return-1!==e.getAttribute("ID").indexOf("."+a+"T")||(e.getAttribute("RecurrenceID")||"").startsWith(a)});return 0===s.length?Promise.reject("[SharepointPlus 'remove'] No event found on "+a):(s=s[0],o.MasterSeriesItemID=s.getAttribute("ID").split(".")[0],o.UID=s.getAttribute("UID"),o.EventType=3,o.fRecurrence=1,o.fAllDayEvent=s.getAttribute("fAllDayEvent")||"0",o.RecurrenceData="No Recurrence",o.RecurrenceID=s.getAttribute("RecurrenceID"),o.Title="Deleted: "+s.getAttribute("Title")||"",o.EventDate=s.getAttribute("EventDate"),o.EndDate=s.getAttribute("EndDate"),d.add(o,l))}for(;i--;)(o=r(u[0])).ID=e[i].getAttribute("ID"),(t=e[i].getAttribute("FileRef"))&&(o.FileRef=d.cleanResult(t)),n.push(o);return delete l.where,d.remove(n,l)}).then(function(e){a(e)}).catch(function(e){s(e)})}if(0!==n){l.progressVar=l.progressVar||{current:0,max:n,passed:[],failed:[],eventID:"spRemove"+(""+Math.random()).slice(2)},n>l.packetsize&&(e=(t=u.slice(0)).splice(0,l.packetsize),_SP_REMOVE_PROGRESSVAR[l.progressVar.eventID]=function(e){return d.remove(t,e)},n=(u=e).length),l.progressVar.current+=n;var o='<Batch OnError="Continue" ListVersion="1"  ViewName="">';for(r=0;r<u.length;r++){if(o+='<Method ID="'+(r+1)+'" Cmd="Delete">',u[r].ID==R)throw"Error 'delete': you have to provide the item ID called 'ID'";o+="<Field Name='ID'>"+u[r].ID+"</Field>",u[r].FileRef!=R&&(o+="<Field Name='FileRef'>"+u[r].FileRef+"</Field>"),o+="</Method>"}o+="</Batch>",d.ajax({url:d.url+"/_vti_bin/lists.asmx",body:d._buildBodyForSOAP("UpdateListItems","<listName>"+d.listID+"</listName><updates>"+o+"</updates>"),headers:{SOAPAction:"http://schemas.microsoft.com/sharepoint/soap/UpdateListItems"}}).then(function(e){var t,r=e.getElementsByTagName("Result"),n=r.length,i=l.progressVar.passed,o=l.progressVar.failed;for(t=0;t<n;t++)"0x00000000"===r[t].getElementsByTagName("ErrorCode")[0].firstChild.nodeValue?i.push(u[t]):(u[t].errorMessage=r[t].getElementsByTagName("ErrorText")[0].firstChild.nodeValue,o.push(u[t]));l.progress(l.progressVar.current,l.progressVar.max),l.progressVar.current<l.progressVar.max?_SP_REMOVE_PROGRESSVAR[l.progressVar.eventID]&&(l.useCallback?_SP_REMOVE_PROGRESSVAR[l.progressVar.eventID](l):_SP_REMOVE_PROGRESSVAR[l.progressVar.eventID](l).then(function(e){a(e)},function(e){s(e)})):(_SP_REMOVE_PROGRESSVAR[l.progressVar.eventID]&&delete _SP_REMOVE_PROGRESSVAR[l.progressVar.eventID],a({passed:i,failed:o}))})}else a({passed:[],failed:[]})})},usergroups:function(a,s){var r=this;return r._promise(function(i,t){if(!a)throw"[SharepointPlus 'usergroups']: the username is required.";if((s=s||{}).cache=!1!==s.cache,s.url){a=a.toLowerCase(),s.url=s.url.toLowerCase();var o=!1;s.cache&&_SP_CACHE_USERGROUPS.forEach(function(e){e.user===a&&e.url===s.url&&(i(e.data),o=!0)}),o||r.ajax({url:s.url+"/_vti_bin/usergroup.asmx",body:r._buildBodyForSOAP("GetGroupCollectionFromUser","<userLoginName>"+a+"</userLoginName>","http://schemas.microsoft.com/sharepoint/soap/directory/"),headers:{SOAPAction:"http://schemas.microsoft.com/sharepoint/soap/directory/GetGroupCollectionFromUser"}}).then(function(e){for(var t=[],r=0,n=(e=e.getElementsByTagName("Group")).length;r<n;r++)t.push(e[r].getAttribute("Name"));o=!1,_SP_CACHE_USERGROUPS.forEach(function(e){e.user===a&&e.url===s.url&&(e.data=t,o=!0)}),o||_SP_CACHE_USERGROUPS.push({user:a,url:s.url,data:t}),i(t)},function(e){t(e)})}else r.getURL().then(function(e){return r.usergroups(a,{url:e})}).then(function(e){i(e)}).catch(function(e){t(e)})})},workflowStatusToText:function(e){switch(e*=1){case 0:return"Not Started";case 1:return"Failed On Start";case 2:return"In Progress";case 3:return"Error Occurred";case 4:return"Stopped By User";case 5:return"Completed";case 6:return"Failed On Start Retrying";case 7:return"Error Occurred Retrying";case 8:return"View Query Overflow";case 15:return"Canceled";case 16:return"Approved";case 17:return"Rejected";default:return"Unknown"}},getWorkflowID:function(d){var f=this;return f._promise(function(c,t){if(f.needQueue)return f._addInQueue("getWorkflowID",arguments);if(!f.listID)throw"[SharepointPlus 'getWorkflowID'] the list ID/Name is required.";if(!f.url)throw"[SharepointPlus 'getWorkflowID'] not able to find the URL!";if(!(d=d||{}).ID||!d.workflowName)throw"[SharepointPlus 'getWorkflowID'] all parameters are mandatory";f.get({fields:"FieldRef",where:"ID = "+d.ID}).then(function(e){if(0===e.length)throw"[SharepointPlus 'getWorkflowID'] I'm not able to find the item ID "+d.ID;var u=f.cleanResult(e[0].getAttribute("FileRef"));f.url.startsWith("http")||(u=h.location.href.split("/").slice(0,3).join("/")+"/"+u),u.startsWith("http")||(u=f.url.split("/").slice(0,3).join("/")+"/"+u),f.ajax({url:f.url+"/_vti_bin/Workflow.asmx",body:f._buildBodyForSOAP("GetWorkflowDataForItem","<item>"+u+"</item>","http://schemas.microsoft.com/sharepoint/soap/workflow/"),headers:{SOAPAction:"http://schemas.microsoft.com/sharepoint/soap/workflow/GetWorkflowDataForItem"}}).then(function(e){var t,r,n={},i=e.getElementsByTagName("WorkflowTemplate");if(0===i.length){var o=SP.ClientContext.get_current(),a=o.get_web().get_lists().getByTitle(f.listID),s=a.getItemById(d.ID);o.load(a),o.load(s);var l=a.get_workflowAssociations();o.load(l),o.executeQueryAsync(function(){for(var e=l.getEnumerator();e.moveNext();){var t=e.get_current();if(t.get_name()===d.workflowName){n={fileRef:u,description:t.get_description(),workflowID:"{"+t.get_id().toString()+"}",instances:[]};break}}c(n)},function(){throw"[SharepointPlus 'getWorkflowID'] Problem while dealing with SP.ClientContext.get_current()"})}else{for(t=i.length;t--;)i[t].getAttribute("Name")==d.workflowName&&(n={fileRef:u,description:i[t].getAttribute("Description"),workflowID:"{"+i[t].getElementsByTagName("WorkflowTemplateIdSet")[0].getAttribute("TemplateId")+"}",instances:[]});if(!n.fileRef)throw"[SharepointPlus 'getWorkflowID'] it seems the requested workflow ('"+d.workflowName+"') doesn't exist!";for(i=e.getElementsByTagName("Workflow"),t=0;t<i.length;t++)r=i[t],n.instances.push({StatusPageUrl:r.getAttribute("StatusPageUrl"),Id:r.getAttribute("Id"),TemplateId:r.getAttribute("TemplateId"),ListId:r.getAttribute("ListId"),SiteId:r.getAttribute("SiteId"),WebId:r.getAttribute("WebId"),ItemId:r.getAttribute("ItemId"),ItemGUID:r.getAttribute("ItemGUID"),TaskListId:r.getAttribute("TaskListId"),AdminTaskListId:r.getAttribute("AdminTaskListId"),Author:r.getAttribute("Author"),Modified:r.getAttribute("Modified"),Created:r.getAttribute("Created"),StatusVersion:r.getAttribute("StatusVersion"),Status1:{code:r.getAttribute("Status1"),text:f.workflowStatusToText(r.getAttribute("Status1"))},Status2:{code:r.getAttribute("Status2"),text:f.workflowStatusToText(r.getAttribute("Status2"))},Status3:{code:r.getAttribute("Status3"),text:f.workflowStatusToText(r.getAttribute("Status3"))},Status4:{code:r.getAttribute("Status4"),text:f.workflowStatusToText(r.getAttribute("Status4"))},Status5:{code:r.getAttribute("Status5"),text:f.workflowStatusToText(r.getAttribute("Status5"))},Status6:{code:r.getAttribute("Status6"),text:f.workflowStatusToText(r.getAttribute("Status6"))},Status7:{code:r.getAttribute("Status7"),text:f.workflowStatusToText(r.getAttribute("Status7"))},Status8:{code:r.getAttribute("Status8"),text:f.workflowStatusToText(r.getAttribute("Status8"))},Status9:{code:r.getAttribute("Status9"),text:f.workflowStatusToText(r.getAttribute("Status9"))},Status10:{code:r.getAttribute("Status10"),text:f.workflowStatusToText(r.getAttribute("Status10"))},TextStatus1:r.getAttribute("TextStatus1"),TextStatus2:r.getAttribute("TextStatus2"),TextStatus3:r.getAttribute("TextStatus3"),TextStatus4:r.getAttribute("TextStatus4"),TextStatus5:r.getAttribute("TextStatus5"),Modifications:r.getAttribute("Modifications"),InternalState:r.getAttribute("InternalState"),ProcessingId:r.getAttribute("ProcessingId")});c(n)}},function(){t("[SharepointPlus 'getWorkflowID'] Something went wrong with the request over the Workflow Web Service...")})})})},startWorkflow:function(o){var a=this;return a._promise(function(t,r){if(a.needQueue)return a._addInQueue("startWorkflow",arguments);if(!a.url)throw"[SharepointPlus 'startWorkflow'] not able to find the URL!";if(!a.listID)return o.platformType=2010,a.startWorkflow2013(o);if(!(o=o||{}).workflowName&&!o.workflowID)throw"[SharepointPlus 'startWorkflow'] Please provide the workflow name";if(!o.ID)throw"[SharepointPlus 'startWorkflow'] Please provide the item ID";if(o.fileRef||o.workflowID){var e,n,i="<root />";if(o.parameters){for(Array.isArray(o.parameters)||(o.parameters=[o.parameters]),e=o.parameters.slice(0),i="<Data>",n=0;n<e.length;n++)i+="<"+e[n].name+">"+e[n].value+"</"+e[n].name+">";i+="</Data>"}a.ajax({url:a.url+"/_vti_bin/Workflow.asmx",body:a._buildBodyForSOAP("StartWorkflow","<item>"+o.fileRef+"</item><templateId>"+o.workflowID+"</templateId><workflowParameters>"+i+"</workflowParameters>","http://schemas.microsoft.com/sharepoint/soap/workflow/"),headers:{SOAPAction:"http://schemas.microsoft.com/sharepoint/soap/workflow/StartWorkflow"}}).then(function(){t()},function(e){r(e)})}else a.getWorkflowID({ID:o.ID,workflowName:o.workflowName}).then(function(e){o.fileRef=e.fileRef,o.workflowID=e.workflowID,a.startWorkflow(o).then(function(e){t(e)},function(e){r(e)})})})},startWorkflow2013:function(d){var t=this;return t._promise(function(u,c){if(t.needQueue)return t._addInQueue("startWorkflow2013",arguments);if(!t.url)throw"[SharepointPlus 'startWorkflow2013'] not able to find the URL!";if((d=d||{}).platformType=d.platformType||2013,!d.workflowName)throw"[SharepointPlus 'startWorkflow2013'] Please provide the workflow name.";if(t.listID&&!d.ID)throw"Error 'startWorkflow2013': Please provide the item ID.";if("undefined"==typeof SP||void 0===SP.SOD)throw"[SharepointPlus 'startWorkflow2013']: SP.SOD.executeFunc is required (from the Microsoft file called init.js)";SP.SOD.executeFunc("sp.js","SP.ClientContext",function(){SP.SOD.registerSod("sp.workflowservices.js",SP.Utilities.Utility.getLayoutsPageUrl("sp.workflowservices.js")),SP.SOD.executeFunc("sp.workflowservices.js","SP.WorkflowServices.WorkflowServicesManager",function(){var a=new SP.ClientContext(t.url),e=a.get_web(),s=SP.WorkflowServices.WorkflowServicesManager.newObject(a,e);a.load(s);var l=s.getWorkflowSubscriptionService().enumerateSubscriptions();a.load(l),a.executeQueryAsync(function(){var e,t,r=l.getEnumerator(),n={},i=!1,o=d.workflowName.toLowerCase();if(d.parameters)for(d.parameters.length===R&&(d.parameters=[d.parameters]),t=0;t<d.parameters.length;t++)n[d.parameters[t].name]=d.parameters[t].value;if(2010==d.platformType){s.getWorkflowInteropService().startWorkflow(o,null,null,null,n),a.executeQueryAsync(function(){u()},function(e,t){var r=t.get_message();"associationName"===r&&(r="No workflow found with the name '"+d.workflowName+"'"),c(r)})}else{for(;r.moveNext();)if((e=r.get_current()).get_name().toLowerCase()===o){d.ID?s.getWorkflowInstanceService().startWorkflowOnListItem(e,d.ID,n):s.getWorkflowInstanceService().startWorkflow(e,n),a.executeQueryAsync(function(){u()},function(e,t){c(t.get_message())}),i=!0;break}i||c("No workflow found with the name '"+d.workflowName+"'")}},function(e,t){c(t.get_message())})})})})},stopWorkflow:function(e){var t=this;return t._promise(function(o,a){if(t.needQueue)return t._addInQueue("startWorkflow",arguments);if(!t.url)throw"[SharepointPlus 'stopWorkflow'] not able to find the URL!";if(!(e=e||{}).workflowName&&!e.workflowID)throw"[SharepointPlus 'stopWorkflow'] Please provide the workflow name";if(!e.ID)throw"[SharepointPlus 'stopWorkflow'] Please provide the item ID";t.getWorkflowID({ID:e.ID,workflowName:e.workflowName}).then(function(e){var t=e.instances.length;if(0===t)return a("[SharepointPlus 'stopWorkflow'] No instances found for this workflow");var r=e.instances[t-1],n=Date.now();c.body.insertAdjacentHTML("beforeend",'<iframe id="iframe_'+n+'" />');var i=c.getElementById("iframe_"+n);i.onload=function(){i.contentWindow.__doPostBack("ctl00$PlaceHolderMain$HtmlAnchorEnd",""),setTimeout(function(){c.body.removeChild(i),o()},1e3)},i.src=r.StatusPageUrl})})},distributionLists:function(a,s){var r=this;return r._promise(function(i,t){if(!a)throw"[SharepointPlus 'distributionLists'] the username is required.";if((s=s||{}).url){a=a.toLowerCase(),s.url=s.url.toLowerCase(),s.cache=!1!==s.cache;var o=!1;s.cache&&_SP_CACHE_DISTRIBUTIONLISTS.forEach(function(e){e.user===a&&e.url===s.url&&(i(e.data),o=!0)}),o||r.ajax({url:s.url+"/_vti_bin/UserProfileService.asmx",body:r._buildBodyForSOAP("GetCommonMemberships","<accountName>"+a+"</accountName>","http://microsoft.com/webservices/SharePointPortalServer/UserProfileService"),headers:{SOAPAction:"http://microsoft.com/webservices/SharePointPortalServer/UserProfileService/GetUserMemberships"}}).then(function(e){for(var t=[],r=0,n=(e=e.getElementsByTagName("MembershipData")).length;r<n;r++)"DistributionList"===e[r].getElementsByTagName("Source")[0].firstChild.nodeValue&&t.push({SourceReference:e[r].getElementsByTagName("SourceReference")[0].firstChild.nodeValue,DisplayName:e[r].getElementsByTagName("DisplayName")[0].firstChild.nodeValue,MailNickname:e[r].getElementsByTagName("MailNickname")[0].firstChild.nodeValue,Url:e[r].getElementsByTagName("Url")[0].firstChild.nodeValue});o=!1,_SP_CACHE_DISTRIBUTIONLISTS.forEach(function(e){e.user===a&&e.url===s.url&&(e.data=t,o=!0)}),o||_SP_CACHE_DISTRIBUTIONLISTS.push({user:a,url:s.url,data:t}),i(t)},function(e){t(e)})}else r.getURL().then(function(e){return s.url=e,r.distributionLists(a,s)}).then(function(e){i(e)}).catch(function(e){t(e)})})},groupMembers:function(a,s){var r=this;return r._promise(function(i,t){if(!a)throw"[SharepointPlus 'groupMembers'] the groupname is required.";if((s=s||{}).cache=!1!==s.cache,s.url||r.url){a=a.toLowerCase(),s.url=s.url.toLowerCase();var o=!1;s.cache&&_SP_CACHE_GROUPMEMBERS.forEach(function(e){e.group===a&&e.url===s.url&&(i(e.data),o=!0)}),o||r.ajax({url:s.url+"/_vti_bin/usergroup.asmx",body:r._buildBodyForSOAP("GetUserCollectionFromGroup","<groupName>"+r._cleanString(a)+"</groupName>","http://schemas.microsoft.com/sharepoint/soap/directory/"),headers:{SOAPAction:"http://schemas.microsoft.com/sharepoint/soap/directory/GetUserCollectionFromGroup"}}).then(function(e){for(var t=[],r=0,n=(e=e.getElementsByTagName("User")).length;r<n;r++)t.push({ID:e[r].getAttribute("ID"),Name:e[r].getAttribute("Name"),LoginName:e[r].getAttribute("LoginName"),Email:e[r].getAttribute("Email")});o=!1,_SP_CACHE_GROUPMEMBERS.forEach(function(e){e.group===a&&e.url===s.url&&(e.data=t,o=!0)}),o||_SP_CACHE_GROUPMEMBERS.push({group:a,url:s.url,data:t}),i(t)},function(e){t(e)})}else r.getURL().then(function(e){return s.url=e,r.groupMembers(a,s)}).then(function(e){i(e)}).catch(function(e){t(e)})})},isMember:function(r){var o=this;return o._promise(function(n,t){if(!(r=r||{}).user)throw"[SharepointPlus 'isMember'] the user is required.";if(!r.group)throw"[SharepointPlus 'isMember'] the group is required.";if(r.cache=!1!==r.cache,r.url){r.group=r.group.toLowerCase();var i=[];o.usergroups(r.user,{cache:r.cache}).then(function(e){for(var t=e.length;t--;)if(e[t].toLowerCase()===r.group)return n(!0),Promise.resolve(!1);return o.groupMembers(r.group,{cache:r.cache})}).then(function(e){if(!1===e)return Promise.resolve(!1);for(var t=e.length;t--;)i.push(e[t].Name.toLowerCase());return o.distributionLists(r.user,{cache:r.cache})}).then(function(e){if(!1!==e){for(var t=!1,r=e.length;r--;)-1<i.indexOf(e[r].DisplayName.toLowerCase())&&(n(!0),t=!0);t||n(!1)}}).catch(function(e){t(e)})}else o.getURL().then(function(e){return r.url=e,o.isMember(r)}).then(function(e){n(e)}).catch(function(e){t(e)})})},people:function(r,n){var i=this;return i._promise(function(a,t){1===arguments.length&&"object"==typeof r&&(n=r,r=""),r=r||"",(n=n||{}).url?i.ajax({url:n.url+"/_vti_bin/UserProfileService.asmx",body:i._buildBodyForSOAP("GetUserProfileByName","<AccountName>"+r+"</AccountName>","http://microsoft.com/webservices/SharePointPortalServer/UserProfileService"),headers:{SOAPAction:"http://microsoft.com/webservices/SharePointPortalServer/UserProfileService/GetUserProfileByName"}}).then(function(e){for(var t,r,n=[],i=0,o=(e=e.getElementsByTagName("PropertyData")).length;i<o;i++)t=e[i].getElementsByTagName("Name")[0].firstChild.nodeValue,r=(r=0<(r=e[i].getElementsByTagName("Value")).length?r[0]:null)&&r.firstChild?r.firstChild.nodeValue:"No Value",n.push(t),n[t]=r;a(n)},function(e){t(e)}):i.getURL().then(function(e){return n.url=e,i.people(r,n)}).then(function(e){a(e)}).catch(function(e){t(e)})})},getUserInfo:function(n,i){var o=this;return o._promise(function(t,r){if("string"!=typeof n)throw"[SharepointPlus 'getUserInfo'] the username is required.";(i=i||{}).url?o.ajax({url:i.url+"/_vti_bin/usergroup.asmx",body:o._buildBodyForSOAP("GetUserInfo","<userLoginName>"+n+"</userLoginName>","http://schemas.microsoft.com/sharepoint/soap/directory/")}).then(function(e){0===(e=e.getElementsByTagName("User")).length?r("[SharepointPlus 'getUserInfo'] nothing returned?!"):t({ID:e[0].getAttribute("ID"),Sid:e[0].getAttribute("Sid"),Name:e[0].getAttribute("Name"),LoginName:e[0].getAttribute("LoginName"),Email:e[0].getAttribute("Email"),Notes:e[0].getAttribute("Notes"),IsSiteAdmin:e[0].getAttribute("IsSiteAdmin"),IsDomainGroup:e[0].getAttribute("IsDomainGroup"),Flags:e[0].getAttribute("Flags")})},function(e){r(e)}):o.getURL().then(function(e){return i.url=e,o.getUserInfo(n,i)}).then(function(e){t(e)}).catch(function(e){r(e)})})},whoami:function(e){return this.people("",e)},regionalSettings:function(e){var r=this;return r._promise(function(a,t){_SP_CACHE_REGIONALSETTINGS?a(_SP_CACHE_REGIONALSETTINGS):e?r.ajax({url:e+"/_layouts/regionalsetng.aspx?Type=User"}).then(function(e){var t,r,n={lcid:"",cultureInfo:"",timeZone:"",calendar:"",alternateCalendar:""},i=c.createElement("div");i.innerHTML=e;var o=function(e){var t=i.querySelector("select[id$='"+e+"']");return t.options[t.selectedIndex].innerHTML};for(n.lcid=i.querySelector("select[id$='LCID']").value,n.cultureInfo=o("LCID"),n.timeZone=o("TimeZone"),n.calendar=o("DdlwebCalType"),n.alternateCalendar=o("DdlwebAltCalType"),t=c.querySelectorAll("input[id*='ChkListWeeklyMultiDays']"),n.workWeek={days:[],firstDayOfWeek:"",firstWeekOfYear:"",startTime:"",endTime:""},r=0;r<t.length;r++)t[r].checked&&n.workWeek.days.push(t[r].nextSibling.querySelector("abbr").getAttribute("title"));n.workWeek.firstDayOfWeek=o("DdlFirstDayOfWeek"),n.workWeek.firstWeekOfYear=o("DdlFirstWeekOfYear"),n.workWeek.startTime=i.querySelector("select[id$='DdlStartTime']").value,n.workWeek.endTime=i.querySelector("select[id$='DdlEndTime']").value,n.timeFormat=o("DdlTimeFormat"),a(_SP_CACHE_REGIONALSETTINGS=n)},function(e){t(e)}):r.getURL().then(function(e){return r.regionalSettings(e)}).then(function(e){a(e)}).catch(function(e){t(e)})})},regionalDateFormat:function(r){var i=this;return i._promise(function(n,t){if(_SP_CACHE_DATEFORMAT)n(_SP_CACHE_DATEFORMAT);else if(r){var e="";"undefined"!=typeof _spRegionalSettings?e=_spRegionalSettings.localeId:_SP_CACHE_REGIONALSETTINGS&&(e=_SP_CACHE_REGIONALSETTINGS.lcid),e?i.ajax({url:r+"/_layouts/iframe.aspx?cal=1&date=1/1/2000&lcid="+e}).then(function(e){var t=c.createElement("div");t.innerHTML=e;var r=t.querySelector('a[id="20000103"]').getAttribute("href").replace(/javascript:ClickDay\('(.*)'\)/,"$1");r=r.replace(/\\u([\d\w]{4})/gi,function(e,t){return String.fromCharCode(parseInt(t,16))}),r=(r=(r=(r=(r=(r=(r=unescape(r)).replace(/20/,"YY")).replace(/00/,"YY")).replace(/03/,"DD")).replace(/3/,"D")).replace(/01/,"MM")).replace(/1/,"M"),n(_SP_CACHE_DATEFORMAT=r)},function(e){t(e)}):i.regionalSettings(r).then(function(){return i.regionalDateFormat(r)}).then(function(e){n(e)}).catch(function(e){t(e)})}else i.getURL().then(function(e){return i.regionalDateFormat(e)}).then(function(e){n(e)}).catch(function(e){t(e)})})},addressbook:function(r,n){var i=this;switch(arguments.length){case 0:r="",n={};break;case 1:"string"==typeof r?n={}:(n=r,r="")}return i._promise(function(u,t){n.url?(n.limit=n.limit||10,n.type=n.type||"User",i.ajax({url:n.url+"/_vti_bin/People.asmx",body:i._buildBodyForSOAP("SearchPrincipals","<searchText>"+r+"</searchText><maxResults>"+n.limit+"</maxResults><principalType>"+n.type+"</principalType>"),headers:{SOAPAction:"http://schemas.microsoft.com/sharepoint/soap/SearchPrincipals"}}).then(function(e){for(var t,r,n,i=[],o=0,a=(e=e.getElementsByTagName("PrincipalInfo")).length;o<a;o++){t=e[o].childNodes,i[o]=[];for(var s=0,l=t.length;s<l;s++)r=t[s].nodeName,(n=t[s].firstChild)&&(n=n.nodeValue),i[o].push(r),i[o][r]=n}u(i)},function(e){t(e)})):i.getURL().then(function(e){return n.url=e,i.addressbook(r,n)}).then(function(e){u(e)}).catch(function(e){t(e)})})},reset:function(){var e=this;return e.data=[],e.length=0,e.listID="",e.needQueue=!1,e.listQueue=[],delete e.url,e},toDate:function(e,t){if(!e)return"";if("string"!=typeof e&&!isNaN(new Date(e)))return e;if("datetime;#"===e.slice(0,10)&&(e=e.slice(10)),19!=e.length&&20!=e.length)throw"[SharepointPlus toDate] '"+e+"' is invalid.";var r=e.substring(0,4),n=e.substring(5,7),i=e.substring(8,10),o=e.substring(11,13),a=e.substring(14,16),s=e.substring(17,19);return-1<e.indexOf("Z")||t?new Date(Date.UTC(r,n-1,i,o,a,s)):new Date(r,n-1,i,o,a,s)},toSPDate:function(e,t){if(!e||"object"!=typeof e||"function"!=typeof e.getFullYear)return"";var r=function(e){return 1==e.toString().length&&(e="0"+e),e},n=r(e.getMonth()+1),i=r(e.getDate()),o=e.getFullYear(),a=r(e.getHours()),s=r(e.getMinutes()),l=r(e.getSeconds());return o+"-"+n+"-"+i+(t?"T"+a+":"+s+":"+l+"Z":"")},getLookup:function(e){if(!e)return{id:"",value:""};var t=e.split(";#");return t.length<=2?{id:t[0],value:void 0===t[1]?t[0]:t[1]}:{id:e.replace(/([0-9]+;#)([^;]+)/g,"$1").replace(/;#;#/g,",").slice(0,-2).split(","),value:e.replace(/([0-9]+;#)([^;]+)/g,"$2").split(";#")}},getPeopleLookup:function(e){if(!e)return{id:"",name:"",username:"",email:""};for(var t=e.split(";#"),r=[],n=0;n<t.length;n+=2)r.push(t[n]+";#"+t[n+1]);return 1===(r=r.map(function(e){var n={id:"",name:"",username:"",email:""};return e.split(",#").forEach(function(e,t){switch(t){case 0:var r=e.split(";#");n.id=r[0],n.name=r[1].replace(/,,/g,",");break;case 1:n.username=e;break;case 2:n.email=e;break;case 4:n.name=e.replace(/,,/g,",")}}),n})).length?r[0]:r},toXSLString:function(e){if("string"!=typeof e)throw"[SharepointPlus 'toXLSString'] '"+e+"' is not a string....";var t,r,n=function(e){var t,r,n,i,o,a,s=new Array("0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"),l="";for(t=0;t<e.length;t++){for(r=e.charAt(t).charCodeAt(0),n=0,i="";16<=r;)n=r%16,r=Math.floor(r/16),i+=s[n];for(o="",a=(i+=s[r]).length-1;0<=a;a--)o+=i.charAt(a);l+="%"+o}return l},i=e.split(" "),o="";for(/^[0-9]/.test(i[0])&&i[0].length<5&&(o=n(e.charAt(0)),e=e.substring(1)),t=0;t<e.length;t++)r=e.charAt(t),!1===/[0-9A-Za-z_]/.test(r)?o+=n(r).toLowerCase():o+=r;return o.replace(/%([a-zA-Z0-9][a-zA-Z0-9])/g,"_x00$1_").substring(0,32)},formfields:function(e,t){return this.plugin("formfields",{fields:e,settings:t})},notify:function(e,t){var r=this;if(e===R)throw"[SharepointPlus notify'] you must provide the message to show.";if("string"!=typeof e)throw"[SharepointPlus notify'] you must provide a string for the message to show.";if((t=t||{}).timeout=isNaN(t.timeout)?5:t.timeout,t.override=!0===t.override,t.overrideAll=!0===t.overrideAll,t.overrideSticky=!1!==t.overrideSticky,t.sticky=!0===t.sticky,t.name=t.name||(new Date).getTime(),t.after=t.after||function(){},t.fake=!0===t.fake,t.ignoreQueue=!0===t.ignoreQueue,!1===_SP_NOTIFY_READY)return _SP_NOTIFY_QUEUE.push({message:e,options:t}),ExecuteOrDelayUntilScriptLoaded(function(){ExecuteOrDelayUntilScriptLoaded(function(){_SP_NOTIFY_READY=!0,r.notify("fake",{fake:!0})},"core.js")},"sp.js"),r;if(!0!==t.ignoreQueue)for(;0<_SP_NOTIFY_QUEUE.length;){var n=_SP_NOTIFY_QUEUE.shift();n.options.ignoreQueue=!0,r.notify(n.message,n.options)}return!0!==t.fake?(0<_SP_NOTIFY.length&&(t.overrideAll?r.removeNotify({all:!0,includeSticky:t.overrideSticky}):t.override&&r.removeNotify(_SP_NOTIFY[_SP_NOTIFY.length-1].name)),_SP_NOTIFY.push({name:t.name,id:SP.UI.Notify.addNotification(e,!0),options:t}),t.sticky||setTimeout(function(){r.removeNotify(t.name,{timeout:!0})},1e3*t.timeout),r):void 0},removeNotify:function(e,t){var r,n=this;switch(arguments.length){case 0:throw"Error 'removeNotify': you must provide 'name' or 'options'.";case 2:if("object"!=typeof t)throw"Error 'removeNotify': you must provide an object for 'options'."}if(1===arguments.length&&"object"==typeof e&&(t=e,e=R),(t=t||{all:!1}).timeout=!0===t.timeout,!1===_SP_NOTIFY_READY&&0<_SP_NOTIFY_QUEUE.length)return setTimeout(function(){n.removeNotify(e,t)},150),n;if(!0===t.all){for(var i=[];0<_SP_NOTIFY.length;)r=_SP_NOTIFY.shift(),!1===t.includeSticky&&!0===r.options.sticky?i.push(r):(SP.UI.Notify.removeNotification(r.id),setTimeout(function(){r.options.after.call(n,r.name,!1)},150));_SP_NOTIFY=i.slice(0)}else if(e!==R)for(var o=0,a=_SP_NOTIFY.length;o<a;o++)if(_SP_NOTIFY[o].name==e)return r=_SP_NOTIFY.splice(o,1)[0],SP.UI.Notify.removeNotification(r.id),setTimeout(function(){r.options.after.call(n,r.name,t.timeout)},150),n;return n},getPageSize:function(e){var t={width:0,height:0},r={width:0,height:0},n=e||h,i=n.document,o=i.documentElement,a=i.querySelector("body");return t.width=n.innerWidth||o.clientWidth||a.clientWidth,t.height=n.innerHeight||o.clientHeight||a.clientHeight,r.width=Math.max(a.scrollWidth,o.scrollWidth,a.offsetWidth,o.offsetWidth,a.clientWidth,o.clientWidth),r.height=Math.max(a.scrollHeight,o.scrollHeight,a.offsetHeight,o.offsetHeight,a.clientHeight,o.clientHeight),c.all&&c.querySelector&&!c.addEventListener&&t.width+4==r.width&&t.height+4==r.height&&(t.width=r.width,t.height=r.height),{vw:t,doc:r}},newGuid:function(){for(var e="",t=0;t<32;t++){var r=Math.floor(16*Math.random());switch(t){case 8:e+="-";break;case 12:r=4,e+="-";break;case 16:r=3&r|8,e+="-";break;case 20:e+="-"}e+=r.toString(16)}return e},showModalDialog:function(u){var r=this;return this._promise(function(a){if(!_SP_MODALDIALOG_LOADED&&!(_SP_MODALDIALOG_LOADED="object"==typeof SP&&"object"==typeof SP.UI&&"function"==typeof SP.UI.ModalDialog&&"function"==typeof SP.UI.ModalDialog.showModalDialog))return LoadSodByKey("sp.ui.dialog.js",function(){_SP_MODALDIALOG_LOADED=!0,r.showModalDialog(u).then(function(e){a(e)})}),r;var e,t;u.id=(u.id||"").replace(/\W+/g,""),u.id=u.id||(new Date).getTime();var l="sp_frame_"+u.id;u.html&&"string"==typeof u.html&&((t=c.createElement("div")).style.padding="10px",t.style.display="inline-block",t.className="sp-showModalDialog",t.id="content_"+l,t.innerHTML=u.html,u.html=t),"calculated"!==u.width&&"calculated"!==u.height||(e=r.getPageSize(),"calculated"===u.width&&(u.width=e.vw.width,768<u.width&&(u.width=2*u.width/3)),"calculated"===u.height&&(u.height=e.vw.height,576<u.height&&(u.height=90*u.height/100))),"full"!==u.width&&"full"!==u.height||(e=r.getPageSize(),"full"===u.width&&(u.width=e.vw.width),"full"===u.height&&(u.height=e.vw.height)),u.wait=!0===u.wait,u.closePrevious=!0===u.closePrevious,!0===u.previousClose&&(u.closePrevious=!0),u.closePrevious&&r.closeModalDialog(),!1===u.showClose&&(u.dialogReturnValueCallback||u.callback)&&(u.showClose=!0,u.hideClose=!0);var s=u.dialogReturnValueCallback||u.callback||function(){};u.dialogReturnValueCallback=function(e,t){var r,n;if("object"==typeof e&&void 0!==e.type&&"closeModalDialog"===e.type){var i=e;e=i.dialogResult,t=i.returnValue,r=i.id}if(r)for(var o=0;o<h.top._SP_MODALDIALOG.length;o++)if(h.top._SP_MODALDIALOG[o].id===r){n=(n=h.top._SP_MODALDIALOG.splice(o,1))[0];break}n||(n=h.top._SP_MODALDIALOG.pop()),h.top.document.body.removeChild(h.top.document.getElementById("style_"+n.id)),s.call(this,e,t),a({dialogResult:e,returnValue:t})};SP.SOD.executeOrDelayUntilScriptLoaded(function(){var e=u.wait?SP.UI.ModalDialog.showWaitScreenWithNoClose(u.title,u.message,u.height,u.width):SP.UI.ModalDialog.showModalDialog(u),t=h.top,r=l,n=t.document.querySelectorAll("body > iframe"),i=n[n.length-1],o=0;if(i.setAttribute("id",r),void 0===t._SP_MODALDIALOG&&(t._SP_MODALDIALOG=[]),t._SP_MODALDIALOG.push({id:r,modal:e,zIndex:i.style.zIndex,options:u,type:"modalDialog"}),t._SP_MODALDIALOG.forEach(function(e){e.zIndex>o&&(o=e.zIndex)}),o--,t.document.body.insertAdjacentHTML("beforeend",'<style id="style_'+r+'">.ms-dlgOverlay { z-index:'+o+" !important; display:block !important }</style>"),!0===u.hideClose){var a=i.nextSibling.querySelector(".ms-dlgCloseBtn");a.parentNode.removeChild(a)}if("function"==typeof u.onload&&u.onload(),u.url&&u.onurlload&&"function"==typeof u.onurlload){var s=t.document.getElementById(r);s&&(s=s.nextSibling),s&&(s=s.querySelector("iframe")),s&&function(r,e){function n(){t||(t=!0,clearTimeout(a),e.call(this))}function i(){"complete"===this.readyState&&n.call(this)}function o(e,t,r){return e.addEventListener?e.addEventListener(t,r):e.attachEvent("on"+t,function(){return r.call(e,h.event)})}var a,t=!1;o(r,"load",function(){var e=r.contentDocument;e||(e=r.contentWindow)&&(e=e.document),e&&n.call(e)}),function e(){var t=r.contentDocument||r.contentWindow.document;0!==t.URL.indexOf("about:")?"complete"===t.readyState?n.call(t):(o(t,"DOMContentLoaded",n),o(t,"readystatechange",i)):a=setTimeout(e,1)}()}(s,u.onurlload)}},"sp.ui.dialog.js")})},closeModalDialog:function(t,r){return SP.SOD.executeOrDelayUntilScriptLoaded(function(){var e;if("object"==typeof t&&void 0!==t.type&&"modalDialog"===t.type)e={id:t.id,dialogResult:r,returnValue:R,type:"closeModalDialog"},t.modal.close(e),t.options.wait&&t.options.dialogReturnValueCallback(e,r);else{if(void 0!==h.top._SP_MODALDIALOG&&0<(e=h.top._SP_MODALDIALOG).length)return(e=e[e.length-1]).modal.close({id:e.id,dialogResult:t,returnValue:r,type:"closeModalDialog"}),e.options.wait&&e.options.dialogReturnValueCallback(t,r),!1;SP.UI.ModalDialog.commonModalDialogClose(t,r)}},"sp.ui.dialog.js"),!1},getModalDialog:function(e){if(void 0!==h.top._SP_MODALDIALOG){var t=h.top._SP_MODALDIALOG;e=e.replace(/\W+/g,"");for(var r=0;r<t.length;r++)if(t[r].id==="sp_frame_"+e)return t[r]}return null},waitModalDialog:function(e,t,r,n){return this.showModalDialog({wait:!0,title:e||"Working...",message:t,width:n,height:r})},resizeModalDialog:function(e){var t,r,n,i,o,a=function(e){return 1*e.replace(/px/,"")},s=h.top;if(!e.id){if(0===s._SP_MODALDIALOG.length)return!1;e.id=s._SP_MODALDIALOG[s._SP_MODALDIALOG.length-1].id.replace(/sp_frame_/,"")}if(!(t=s.document.getElementById("sp_frame_"+e.id)))return!1;for(o in t=t.nextSibling,e.width=e.width===R?a(t.style.width):e.width,e.height=e.height===R?a(t.style.height):e.height,r={Border:t.querySelector(".ms-dlgBorder"),TitleText:t.querySelector(".ms-dlgTitleText"),Content:t,Frame:t.querySelector(".ms-dlgFrame")},n=e.width-a(r.Border.style.width),i=e.height-a(r.Border.style.height),r)r.hasOwnProperty(o)&&r[o]&&(r[o].style.width=a(r[o].style.width)+n+"px","TitleText"!==o&&(r[o].style.height=a(r[o].style.height)+i+"px"));var l=this.getPageSize(s);t.style.top=l.vw.height/2-a(t.style.height)/2+"px",t.style.left=l.vw.width/2-a(t.style.width)/2+"px"},getTimeZoneInfo:function(e){var n=this;return this._promise(function(t,r){if(!(e=e||{}).url)return n._getURL().then(function(e){return n.getTimeZoneInfo({url:e})}).then(function(e){t(e)}).catch(function(e){r(e)});n.ajax({url:e.url+"/_api/web/RegionalSettings/TimeZone"}).then(function(e){t({ID:e.d.Id,Description:e.d.Description,Bias:e.d.Information.Bias,StandardBias:e.d.Information.StandardBias,DaylightBias:e.d.Information.DaylightBias,XMLTZone:"<timeZoneRule><standardBias>"+(1*e.d.Information.Bias+1*e.d.Information.StandardBias)+"</standardBias><additionalDaylightBias>"+e.d.Information.DaylightBias+"</additionalDaylightBias></timeZoneRule>"})}).catch(function(e){r(e)})})},registerPlugin:function(e,t){if(void 0!==_SP_PLUGINS[e])throw"[SharepointPlus 'registerPlugin'] '"+e+"' is already registered.";return _SP_PLUGINS[e]=t,!0},plugin:function(e,t){if(t=t||{},"function"==typeof _SP_PLUGINS[e])return _SP_PLUGINS[e].call(this,t);throw"[SharepointPlus 'plugin']: the plugin '"+e+"' is not registered."}};var t,r,O=((t=function(e){return new r(e)}).fn=(r=function(e){return this.mynode=e,this.singleList=!0,this}).prototype={getAttribute:function(e){return this.mynode.getAttribute("ows_"+e.replace(/ /g,""))},getAttributes:function(){return this.mynode.attributes}},t),L=function(e){this.attributes=e};L.prototype.getAttribute=function(e){return this.attributes[e]},L.prototype.getAttributes=function(){return this.attributes},e.prototype.noConflict=function(){h._$SP=h._SharepointPlus=h.$SP},_SP_ISBROWSER||"undefined"==typeof exports?h.$SP=h.SharepointPlus=e:("undefined"!=typeof module&&module.exports&&(exports=module.exports=e),exports.SharepointPlus=e)}("undefined"!=typeof window?window:this,"undefined"!=typeof document?document:null);
