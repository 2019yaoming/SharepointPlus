if("undefined"==typeof $SP)throw"Error formfields: SharepointPlus must be loaded first!";var _SP_CACHE_FORMFIELDS=null;$SP().registerPlugin("formfields",function(options){var spThis=this,SharepointPlusFormFields=function(){this.data=[],this.length=0};return SharepointPlusFormFields.prototype.reset=function(){this.data=[],this.length=0},SharepointPlusFormFields.prototype.formfields=function(fields,settings){"use strict";this.reset(),1!==arguments.length&&(2!==arguments.length||settings)||"string"==typeof fields||Array.isArray(fields)||(settings=fields,fields=void 0),settings=settings||{},fields=fields||[],settings.cache=settings.cache!==!1;var aReturn=[],bigLimit=1e4;"string"==typeof fields&&(fields=""===fields?[]:fields.split(","));var limit=fields.length>0?fields.length:bigLimit;if(limit!==bigLimit||settings.mandatory||(settings.includeAll=!0),settings.cache&&null!==_SP_CACHE_FORMFIELDS){var allFields=_SP_CACHE_FORMFIELDS.slice(0);if(settings.includeAll)return this.length=allFields.length,this.data=allFields,this;var done=0,i,len=allFields.length,idx,fieldNames=[];for(i=0;len>i;i++)fieldNames.push(allFields[i]._name);for(i=0;limit>i;i++)idx=fieldNames.indexOf(fields[i]),idx>-1&&aReturn.push(allFields[idx]);for(i=0,len=settings.mandatory?allFields.length:0;len>i;i++)allFields[i]._isMandatory&&-1===fields.indexOf(allFields[i]._name)&&aReturn.push(allFields[i]);return this.length=aReturn.length,this.data=aReturn,this}settings.includeAll=!0,settings.cache=!0;var getFieldInfoFromComments=function(e){var t=[];if("undefined"==typeof document.createNodeIterator)for(var i={COMMENT_NODE:8},n=e.childNodes,r=0,l=n.length;l>r;r++)n[r].nodeType==i.COMMENT_NODE&&t.push(n[r].nodeValue);else for(var o,s=function(){return NodeFilter.FILTER_ACCEPT},a=document.createNodeIterator(e,NodeFilter.SHOW_COMMENT,s,!1);o=a.nextNode();)t.push(o.nodeValue);var c=t.join("").replace(/\s\s*/g," ").match(/FieldName="([^"]+)".* FieldInternalName="([^"]+)".* FieldType="([^"]+)"/);return c?{Name:c[1],InternalName:c[2],SPType:c[3]}:{Name:"",InternalName:"",SPType:""}},getText=function(e){var t,i,n=e.nodeType,r="";if(n){if(1===n||9===n||11===n){if("string"==typeof e.textContent)return e.textContent;if("string"==typeof e.innerText)return e.innerText.replace(/\r/g,"");for(e=e.firstChild;e;e=e.nextSibling)r+=getText(e)}else if(3===n||4===n)return e.nodeValue}else for(t=0;i=e[t];t++)8!==i.nodeType&&(r+=getText(i));return r},setSelectedOption=function(e,t,i){i=i||"text";for(var n,r=e.querySelectorAll("option"),l=Array.isArray(t),o=0,s=r.length;s>o;o++)"all"===i?r[o].selected=!0:"none"===i?r[o].selected=!1:(n="text"===i?r[o].innerHTML:r[o].value,r[o].selected=l?t.indexOf(n)>-1:t==n)},getSelectedOption=function(e,t){t=t||"text";for(var i=e.querySelectorAll("option"),n=[],r=null!==e.getAttribute("multiple"),l=0,o=i.length;o>l;l++)if(i[l].selected){if("text"===t){if(n.push(getText(i[l])),r)continue;return n[0]||""}if("value"===t){if(n.push(i[l].value),r)continue;return n[0]||""}if("both"===t){if(n.push({text:getText(i[l]),value:i[l].value}),r)continue;return n[0]||""}}return r?n:0===n.length?"":n};settings.includeAll&&(limit=bigLimit);for(var a=document.querySelectorAll("td.ms-formbody"),i=-1,len=a.length,done=0;len>i&&limit>done;i++){var tr,td,isMandatory=!1,html,txt,infoFromComments,includeThisField=!1,search,fieldName,obj,tmp;if(settings.includeAll&&(includeThisField=!0),-1===i)(includeThisField||fields.indexOf("Content Type")>-1)&&(infoFromComments={Name:"Content Type",InternalName:"Content_x0020_Type",SPType:"SPContentType"},includeThisField=!0);else{if(tr=a[i].parentNode,td=tr.querySelector("td.ms-formbody"),infoFromComments=getFieldInfoFromComments(a[i]),!infoFromComments.Name){if("idAttachmentsRow"!==tr.getAttribute("id"))continue;infoFromComments={Name:"Attachments",InternalName:"Attachments",SPType:"SPAttachments"},includeThisField=!0}if(txt=tr.querySelector("td.ms-formlabel nobr"),!txt)continue;txt=getText(txt),isMandatory=/ \*$/.test(txt),settings.mandatory&&isMandatory?includeThisField=!0:limit!==bigLimit&&fields.indexOf(infoFromComments.Name)>-1&&(includeThisField=!0,done++)}if(includeThisField){if(fieldName=infoFromComments.Name.replace(/&#39;/g,"'"),obj={_name:fieldName,_internalname:infoFromComments.InternalName,_isMandatory:isMandatory,_description:"",_elements:[],_tr:null,_type:null},"Content Type"===fieldName){if(obj._elements=document.querySelector('.ms-formbody select[title="Content Type"]'),!obj._elements)continue;obj._type="content type",obj._tr=obj._elements.parentNode.parentNode}else obj._tr=tr;if(obj.val=function(){},obj.elem=function(e){e=e!==!1;var t=this._elements,i="function"==typeof jQuery&&e===!0;if(t instanceof NodeList&&(t=[].slice.call(t)),!Array.isArray(t))return i?jQuery(t):t;switch(t.length){case 0:return i?jQuery():null;case 1:return i?jQuery(t[0]):t[0];default:return i?jQuery(t):t}},obj.description=function(){return this._description},obj.type=function(){return this._type},obj.row=function(){return"function"==typeof jQuery?jQuery(this._tr):this._tr},obj.name=function(){return this._name},obj.internalname=function(){return this._internalname},obj.isMandatory=function(){return this._isMandatory},obj.options=function(){},"Attachments"===obj._name)obj._type="attachments",obj.elem=function(e){e=e!==!1;var t=document.getElementById("idAttachmentsRow").querySelector(".ms-formbody").querySelectorAll("tr"),i="function"==typeof jQuery&&e===!0;switch(t.length){case 0:return i?jQuery():null;case 1:return i?jQuery(t[0]):t[0];default:return i?jQuery(t):t}},obj.val=function(e){if("undefined"==typeof e){e=[];var t=this.elem(!1);if(t){t.length||(t=[t]);for(var i=0;i<t.length;i++)e.push(getText(t[i].querySelector("span")))}return e}return this};else if("Content Type"===obj._name)obj.val=function(v){var e=this.elem(!1);return"undefined"==typeof v?getSelectedOption(e,"text"):(setSelectedOption(e,v,"text"),eval("!function() {"+e.getAttribute("onchange").replace(/javascript:/,"")+"}()"),this)};else switch(tmp=td.querySelector(".ms-metadata"),tmp&&tmp.parentNode==td?obj._description=getText(tmp).trim():(tmp=td.childNodes,tmp=tmp[tmp.length-1],3==tmp.nodeType&&(obj._description=getText(tmp).trim())),infoFromComments.SPType){case"SPFieldText":case"SPFieldCurrency":case"SPFieldNumber":switch(infoFromComments.SPType){case"SPFieldCurrency":obj._type="currency";break;case"SPFieldNumber":obj._type="number";break;default:obj._type="text"}obj._elements.push(td.querySelector('input[type="text"]')),obj.val=function(e){var t=this.elem(!1);return"undefined"!=typeof e?(t.value=e,this):t.value};break;case"SPFieldNote":obj._type="text multiple",tmp=td.querySelector("textarea"),tmp?(obj._elements.push(tmp),obj.val=function(e){var t=this.elem(),i=this.type();if("iframe"===t[0].tagName.toLowerCase()){var n=1===t.length?t[0]:t[1],r=n.contentDocument?n.contentDocument:n.contentWindow.document;if(!e)return r.querySelector("div").innerHTML;r.querySelector("div").innerHTML=e}else{if("undefined"==typeof e)return t[0].value;t[0].value=e,"text multiple"===i&&(t[0].innerHTML=e)}return this}):(obj._type="html multiple",obj._elements.push(td.querySelector("div")),obj.val=function(e){var t=this.elem();if(t=t[0].querySelector("div[contenteditable]")){if(void 0===e)return t.innerHTML.replace(/^<div class="?ExternalClass[0-9A-Z]+"?>([\s\S]*)<\/div>$/i,"$1").replace(/<span (rtenodeid="1" )?id="?ms-rterangecursor-start"?><\/span><span (rtenodeid="3" )?id="?ms-rterangecursor-end"?([^>]+)?><\/span>/gi,"").replace(/^<p>â€‹<\/p>$/,"");t.innerHTML=e}return void 0!==e?this:null});break;case"SPFieldUser":case"SPFieldUserMulti":obj._type="people"+("SPFieldUserMulti"===infoFromComments.SPType?" multiple":""),tmp=td.querySelector('div[contenteditable="true"]'),tmp?(obj._elements.push(tmp),obj._elements.push(td.querySelector("textarea")),!function(){for(var e=td.querySelectorAll("a"),t=0;t<e.length;t++)obj._elements.push(e[t])}()):obj._elements.push(td.querySelector("div[id]")),"function"==typeof GetPickerControlValue&&(tmp=td.querySelector("table.ms-usereditor"),tmp&&(tmp=tmp.querySelectorAll("span"),tmp&&(obj._description=getText(tmp[tmp.length-1]).trim()))),obj.val=function(e){var t,i,n=[],r=!1,l=this.elem(!1);if("object"!=typeof e||Array.isArray(e)||e.extend!==!0||(e=void 0,r=!0),i=(Array.isArray(l)?l[0]:l).getAttribute("id").replace(/_upLevelDiv$/,""),"undefined"==typeof e)return"function"==typeof GetPickerControlValue?r===!1?GetPickerControlValue(i,!1,!0).trim():(e=GetPickerControlValue(i,!1,!1),t=document.createElement("div"),t.innerHTML=e,e=t.querySelector("#divEntityData"),e?{Key:e.getAttribute("key"),DisplayText:e.getAttribute("DisplayText")}:{Key:"",DisplayText:GetPickerControlValue(i,!1,!0).trim()}):"function"==typeof SPClientPeoplePicker?(t=SPClientPeoplePicker.SPClientPeoplePickerDict[i],t?(t=t.GetAllUserInfo(),r?0===t.length?{Key:"",DisplayText:""}:1===t.length?t[0]:t:(t.forEach(function(e){n.push(e.DisplayText)}),0===n.length?"":1===n.length?n[0]:n)):""):JSON.parse(this.elem(!1).querySelector("input").value)[0].ResolveText;if("function"==typeof EntityEditorCallback)Array.isArray(e)||(e=[e]),t='<Entities Append="False" Error="" Separator=";" MaxHeight="3">',e.forEach(function(e){t+='<Entity Key="'+e+'" DisplayText="'+e+'" IsResolved="False" Description="'+e+'"><MultipleMatches /></Entity>'}),t+="</Entities>",EntityEditorCallback(t,i,!1),e=getUplevel(i),WebForm_DoCallback(i.replace(/(ctl\d+)(\_)/g,"$1$").replace(/(^ctl\d+\$m)(\_)/,"$1$").replace(/\_ctl/,"$ctl"),e,EntityEditorHandleCheckNameResult,i,EntityEditorHandleCheckNameError,!0);else{if("function"!=typeof SPClientPeoplePicker)throw new Error("$SP().formfields().val() failed with a People Picker, because EntityEditorCallback and SPClientPeoplePicker are not available!");if(n=SPClientPeoplePicker.SPClientPeoplePickerDict[i],!n)throw new Error("$SP().formfields().val() failed with a People Picker, because SPClientPeoplePicker.SPClientPeoplePickerDict['"+i+"'] returned an unexpected value");if(t=document.getElementById(n.ResolvedListElementId))for(t=t.querySelectorAll("span"),i=t.length;i--;)n.DeleteProcessedUser();Array.isArray(e)&&(e=e.join(";")),n.AddUserKeys(e,!1)}return this};break;case"SPFieldChoice":case"SPFieldMultiChoice":obj._type="choices",tmp=td.querySelector("table"),tmp?(tmp=td.querySelector("select"),tmp?(obj._type="choices plus",obj._elements=td.querySelectorAll("input,select")):(tmp=td.querySelector('input[type="checkbox"]'),tmp?obj._type="choices checkbox":obj._type="choices radio",tmp=td.querySelector('input[type="text"]'),tmp&&(obj._type+=" plus"),obj._elements=td.querySelectorAll("input"))):obj._elements=td.querySelector("select"),obj.val=function(e){var t,i,n,r=this.elem(!1),l=this.type();if("undefined"==typeof e)switch(l){case"choices":return getSelectedOption(r,"text");case"choices plus":return r[0].checked?getSelectedOption(r[1],"text"):r[3].value;case"choices radio":for(t=0;t<r.length;t++)if(r[t].checked)return getText(r[t].nextSibling);return"";case"choices radio plus":for(t=0;t<r.length-2;t++)if(r[t].checked)return getText(r[t].nextSibling);return r[t].checked?r[t+1].value:"";case"choices checkbox":case"choices checkbox plus":for(e=[],i="choices checkbox plus"===l,n=r.length,i&&n--,t=0;n>t;t++)r[t].checked&&e.push(i&&t+1===n?r[n].value:getText(r[t].nextSibling));return e}else switch(l){case"choices":setSelectedOption(r,e,"text");break;case"choices plus":r[0].checked=!0,setSelectedOption(r[1],e,"text"),getSelectedOption(r[1],"text")!==e?(r[2].checked=!0,r[3].value=e):r[3].value="";break;case"choices checkbox":case"choices checkbox plus":for(Array.isArray(e)||(e=[e]),n=r.length,"choices checkbox plus"===l&&(n-=2),t=0;n>t;t++)idx=e.indexOf(getText(r[t].nextSibling)),idx>-1?(r[t].checked=!0,e.splice(idx,1)):r[t].checked=!1;"choices checkbox plus"===l&&(e.length>0?(r[r.length-2].checked=!0,r[r.length-1].value=e[0]):(r[r.length-2].checked=!1,r[r.length-1].value=""));break;case"choices radio":case"choices radio plus":for(i=!1,n=r.length,"choices radio plus"===l&&(n-=2),t=0;n>t;t++)if(getText(r[t].nextSibling)==e){r[t].checked=!0,i=!0;break}"choices radio plus"===l&&(i?r[t+1].value="":(r[t].checked=!0,r[t+1].value=e))}return this};break;case"SPFieldDateTime":obj._type="date",tmp=td.querySelectorAll("input,select,a"),tmp.length>2&&(obj._type+=" time"),obj._elements=obj._elements.concat(tmp),obj.val=function(e){var t=this.elem();return"undefined"!=typeof e?(Array.isArray(e)||(e=[e]),t[0].value=e[0],4===t.length&&(e.length>1&&setSelectedOption(t[2],e[1]),e.length>2&&setSelectedOption(t[3],e[2])),this):4===t.length?[t[0].value,getSelectedOption(t[2],"text"),t[3].value]:t[0].value};break;case"SPFieldLookup":case"SPFieldLookupMulti":obj._type="lookup",obj._elements=td.querySelectorAll('select,input[id$="Button"],button'),"SPFieldLookupMulti"===infoFromComments.SPType?obj._type+=" multiple":obj._elements=obj._elements[0],obj.val=function(v){var params="text";"object"!=typeof v||Array.isArray(v)||(params=v.selectReturn||"text",v=void 0);var type=this.type(),e=this.elem(!1),o;if("undefined"==typeof v){if("lookup multiple"===type){for(e=e[3].querySelectorAll("option"),v=[],o=0;o<e.length;o++)v.push("text"===params?getText(e[o]):e[o].value);return 0===v.length?"":v}return getSelectedOption(e,params)}if("lookup multiple"===type){Array.isArray(v)||(v=[v]);var clickAdd=e[1].getAttribute("onclick"),clickRemove=e[2].getAttribute("onclick"),masterGroup=window[e[1].getAttribute("id").replace(/AddButton/,"MultiLookup_m")];for(setSelectedOption(e[3],"","all"),clickRemove?eval("!function() {"+clickRemove+"}()"):"function"==typeof GipRemoveSelectedItems&&GipRemoveSelectedItems(masterGroup),setSelectedOption(e[0],"","none"),o=0;o<v.length;o++)setSelectedOption(e[0],v[o],params),clickAdd?eval("!function() {"+clickAdd+"}()"):"function"==typeof GipAddSelectedItems&&GipAddSelectedItems(masterGroup)}else setSelectedOption(e,v,params);return this};break;case"SPFieldBoolean":obj._type="boolean",obj._elements=td.querySelector("input"),obj.val=function(e){var t=this.elem(!1);return"undefined"!=typeof e?(t.checked=1==e,this):t.checked};break;case"SPFieldURL":obj._type="url",obj._elements=td.querySelectorAll("span.ms-formdescription,input"),obj.val=function(e){var t=this.elem();return"undefined"!=typeof e&&(Array.isArray(e)||(e=[e,e]),e.length<2&&(e=[e[0],e[0]]),t[1].value=e[0],t[3].value=e[1]),[t[1].value,t[3].value]}}}aReturn.push(obj)}return _SP_CACHE_FORMFIELDS=aReturn.slice(0),settings.includeAll=!1,this.formfields(fields,settings)},SharepointPlusFormFields.prototype.each=function(e){for(var t=0,i=this.data.length;i>t;t++)e.call(this.data[t]);return this},SharepointPlusFormFields.prototype.val=function(e){var t=!1,i=!1;if("object"!=typeof e||Array.isArray(e)||(t=e.identity===!0,i=e.extend===!0,e=void 0),"undefined"==typeof e){var n=[];return this.each(function(){t===!0?n[this.name()]=this.val():i===!0&&"people"===this.type().slice(0,6)?n.push(this.val({extend:i})):n.push(this.val())}),0===n.length?"":1===n.length?n[0]:n}if("object"!=typeof e)this.each(function(){this.val(e)});else{var r=0;if(this.length>1){if(e.length!==this.length)throw new Error("$SP.formfields.val: the array passed for val() must have the same size as the number of fields in formfields()");this.each(function(){this.val(e[r++])})}else this.each(function(){this.val(e)})}return this},SharepointPlusFormFields.prototype.elem=function(e){e=e!==!1;var t=[],i="function"==typeof jQuery&&e===!0;switch(this.each(function(){var e=this.elem(!1);e instanceof NodeList&&(e=[].slice.call(e)),t=t.concat(e)}),t.length){case 0:return i?jQuery():null;case 1:return i?jQuery(t[0]):t[0];default:return i?jQuery(t):t}},SharepointPlusFormFields.prototype.row=function(){var e=[],t="function"==typeof jQuery;switch(this.each(function(){var i=this.row();t&&i instanceof jQuery==!0&&(i=i[0]),e.push(i)}),e.length){case 0:return t?jQuery():null;case 1:return t?jQuery(e[0]):e[0];default:return t?jQuery(e):e}},SharepointPlusFormFields.prototype.type=function(){var e=[];switch(this.each(function(){e.push(this.type())}),e.length){case 0:return"";case 1:return e[0];default:return e}},SharepointPlusFormFields.prototype.description=function(){var e=[];switch(this.each(function(){e.push(this.description())}),e.length){case 0:return"";case 1:return e[0];default:return e}},SharepointPlusFormFields.prototype.isMandatory=function(){var e=[];switch(this.each(function(){e.push(this.isMandatory())}),e.length){case 0:return!1;case 1:return e[0];default:return e}},SharepointPlusFormFields.prototype.name=function(){var e=[];switch(this.each(function(){e.push(this.name())}),e.length){case 0:return"";case 1:return e[0];default:return e}},SharepointPlusFormFields.prototype.internalname=function(){var e=[];switch(this.each(function(){e.push(this.internalname())}),e.length){case 0:return"";case 1:return e[0];default:return e}},(new SharepointPlusFormFields).formfields(options.fields,options.settings)});
